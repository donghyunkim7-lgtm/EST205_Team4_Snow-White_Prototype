<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snow White - Structural Critique</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
    
    body {
      font-family: 'Crimson Text', Georgia, serif;
      background: linear-gradient(to bottom, #0f172a, #581c87, #0f172a);
      min-height: 100vh;
      color: white;
      padding: 20px;
    }

    .container { max-width: 720px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.5rem; margin-bottom: 8px; text-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .header .subtitle { color: #c4b5fd; font-size: 0.9rem; }
    .header .question { color: #a78bfa; font-size: 0.75rem; font-style: italic; margin-top: 5px; }

    .card {
      background: rgba(30, 41, 59, 0.9);
      border-radius: 16px;
      padding: 24px 28px;
      margin-bottom: 20px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card.inner-thought { background: rgba(88, 28, 135, 0.5); border-color: rgba(192, 132, 252, 0.4); }
    .card.choice { border-color: rgba(251, 191, 36, 0.4); }
    .card.convergence { border: 3px solid #f97316; background: rgba(88, 28, 135, 0.5); }
    .card.convergence-red { border: 3px solid #dc2626; background: rgba(88, 28, 135, 0.5); }
    .card.convergence-purple { border: 3px solid #9333ea; background: rgba(88, 28, 135, 0.5); }
    .card.ending-critique { background: linear-gradient(135deg, #450a0a, #7f1d1d); border-color: #f87171; }
    .card.ending-aspirational { background: linear-gradient(135deg, #064e3b, #047857); border-color: #34d399; }

    .label {
      display: inline-flex; align-items: center; gap: 8px;
      font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.5px;
      margin-bottom: 12px; padding: 4px 10px; border-radius: 4px;
    }
    .label.narration { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
    .label.thought { background: rgba(192, 132, 252, 0.2); color: #c4b5fd; }
    .label.decision { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .label.convergence { background: rgba(249, 115, 22, 0.3); color: #fb923c; }
    .label.convergence-red { background: rgba(220, 38, 38, 0.3); color: #f87171; }
    .label.convergence-purple { background: rgba(147, 51, 234, 0.3); color: #c084fc; }

    .text { font-size: 1.15rem; line-height: 1.7; margin-bottom: 20px; }
    .text.italic { font-style: italic; color: #e9d5ff; }

    .btn {
      display: block; width: 100%; padding: 14px 20px; border: none; border-radius: 12px;
      font-family: inherit; font-size: 1rem; cursor: pointer; transition: all 0.2s; text-align: left;
    }
    .btn:hover { transform: scale(1.01); }
    .btn:active { transform: scale(0.99); }
    .btn-primary { background: linear-gradient(to right, #9333ea, #db2777); color: white; text-align: center; font-weight: 500; }
    .btn-primary:hover { background: linear-gradient(to right, #a855f7, #ec4899); }
    .btn-choice { background: linear-gradient(to right, #334155, #475569); color: white; margin-bottom: 10px; border: 1px solid rgba(100, 116, 139, 0.5); }
    .btn-choice:hover { background: linear-gradient(to right, #b45309, #c2410c); border-color: rgba(251, 191, 36, 0.5); }
    .btn-choice .subtext { font-size: 0.8rem; color: #94a3b8; margin-top: 4px; font-style: italic; }
    .btn-choice:hover .subtext { color: #fde68a; }
    .btn-ghost { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); text-align: center; margin-top: 10px; }
    .btn-ghost:hover { background: rgba(255,255,255,0.2); }
    .btn-small { display: inline-block; width: auto; padding: 8px 16px; font-size: 0.85rem; margin: 4px; }
    .btn-convergence { background: linear-gradient(to right, #c2410c, #ea580c); color: white; text-align: center; margin-top: 10px; border: 2px dashed #fbbf24; }
    .btn-convergence:hover { background: linear-gradient(to right, #dc2626, #f97316); }

    .framework-badge {
      display: flex; align-items: center; gap: 10px; padding: 12px 16px;
      border-radius: 8px 8px 0 0; margin: -24px -28px 20px -28px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .framework-badge.critique { background: rgba(127, 29, 29, 0.3); color: #fca5a5; }
    .framework-badge.aspirational { background: rgba(6, 78, 59, 0.3); color: #6ee7b7; }
    .framework-badge .icon { font-size: 1.3rem; }
    .framework-badge .name { font-weight: bold; font-size: 0.85rem; }
    .framework-badge .subtitle { font-size: 0.7rem; opacity: 0.8; }

    .critique-box {
      border-left: 3px solid #f87171; padding: 12px 16px; margin: 16px 0;
      background: rgba(127, 29, 29, 0.2); border-radius: 0 8px 8px 0;
    }
    .critique-box .c-label { font-size: 0.7rem; text-transform: uppercase; color: #f87171; margin-bottom: 6px; }
    .critique-box .c-text { color: #fecaca; font-size: 0.95rem; }

    .insight-box {
      border: 1px solid #34d399; padding: 14px 18px; margin: 16px 0;
      background: rgba(6, 78, 59, 0.2); border-radius: 8px; text-align: center;
    }
    .insight-box .i-label { font-size: 0.7rem; text-transform: uppercase; color: #34d399; margin-bottom: 6px; letter-spacing: 2px; }
    .insight-box .i-text { color: #a7f3d0; font-size: 1rem; }

    .divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 24px 0; padding-top: 20px; }
    .retry-section { text-align: center; }
    .retry-section p { font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 12px; }

    .journey { display: flex; align-items: center; justify-content: center; gap: 6px; margin-top: 20px; font-size: 0.75rem; color: rgba(167, 139, 250, 0.5); }
    .journey-item { background: rgba(88, 28, 135, 0.5); padding: 4px 8px; border-radius: 4px; }

    .audio-controls { position: fixed; top: 16px; right: 16px; display: flex; gap: 8px; z-index: 100; }
    .audio-btn { background: rgba(30, 41, 59, 0.9); border: none; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; transition: background 0.2s; }
    .audio-btn:hover { background: rgba(51, 65, 85, 0.9); }
    .audio-btn.active { background: rgba(147, 51, 234, 0.7); }
    .audio-panel { position: absolute; top: 50px; right: 0; background: rgba(30, 41, 59, 0.95); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; padding: 16px; width: 300px; display: none; }
    .audio-panel.show { display: block; }
    .audio-panel h4 { margin-bottom: 12px; font-size: 0.9rem; }
    .audio-panel label { display: block; font-size: 0.75rem; color: #c4b5fd; margin-bottom: 4px; }
    .audio-panel input[type="range"] { width: 100%; margin-bottom: 12px; }
    .audio-panel select { width: 100%; padding: 8px; margin-bottom: 12px; border-radius: 6px; background: #1e293b; color: white; border: 1px solid rgba(139, 92, 246, 0.3); font-size: 0.8rem; }
    .audio-panel .file-btn { width: 100%; padding: 10px; background: #7c3aed; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.8rem; margin-bottom: 8px; }
    .audio-panel .file-btn:hover { background: #8b5cf6; }
    .audio-panel .status { font-size: 0.7rem; color: #94a3b8; margin-bottom: 8px; }
    .audio-panel .status.loaded { color: #4ade80; }
    .audio-panel .section-title { font-size: 0.8rem; color: #a78bfa; margin: 16px 0 8px 0; padding-top: 12px; border-top: 1px solid rgba(139, 92, 246, 0.2); }
    .voice-info { font-size: 0.75rem; color: #6ee7b7; margin-bottom: 10px; padding: 8px 12px; background: rgba(16, 185, 129, 0.15); border-radius: 8px; border: 1px solid rgba(52, 211, 153, 0.3); }

    .tts-indicator {
      position: fixed; bottom: 20px; right: 20px; background: rgba(147, 51, 234, 0.9);
      padding: 10px 16px; border-radius: 20px; font-size: 0.8rem; display: none;
      align-items: center; gap: 8px; z-index: 100;
    }
    .tts-indicator.show { display: flex; }
    .tts-indicator .pulse { width: 8px; height: 8px; background: #a7f3d0; border-radius: 50%; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .footer { text-align: center; margin-top: 30px; font-size: 0.75rem; color: rgba(167, 139, 250, 0.4); }
    .stars { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
    .star { position: absolute; width: 2px; height: 2px; background: white; border-radius: 50%; opacity: 0.5; animation: twinkle 2s infinite; }
    @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.8; } }
    .hidden-input { display: none; }
  </style>
</head>
<body>
  <div class="stars" id="stars"></div>
  
  <div class="audio-controls">
    <button class="audio-btn active" id="ttsBtn" title="Narration ON">üéôÔ∏è</button>
    <button class="audio-btn" id="muteBtn" title="Mute">üîä</button>
    <button class="audio-btn" id="settingsBtn" title="Settings">‚öôÔ∏è</button>
    <div class="audio-panel" id="audioPanel">
      <h4>üéµ Audio Settings</h4>
      
      <div class="section-title">üá¨üáß British English Narration</div>
      <div class="voice-info" id="voiceInfo">Loading voices...</div>
      <label>Voice</label>
      <select id="voiceSelect"></select>
      <label>Speech Rate: <span id="rateValue">0.9</span></label>
      <input type="range" id="speechRate" min="0.5" max="1.2" step="0.05" value="0.9">
      <label>Pitch: <span id="pitchValue">1.0</span></label>
      <input type="range" id="speechPitch" min="0.8" max="1.2" step="0.05" value="1.0">
      
      <div class="section-title">üéµ Background Music</div>
      <div class="status" id="musicStatus">üéµ No music loaded</div>
      <button class="file-btn" onclick="document.getElementById('bgmInput').click()">üìÅ Select BGM (MP3)</button>
      <input type="file" id="bgmInput" class="hidden-input" accept="audio/*">
      <label>Music Volume</label>
      <input type="range" id="bgmVolume" min="0" max="1" step="0.1" value="0.15">
      
      <div class="section-title">üîä Sound Effects</div>
      <label>Effects Volume</label>
      <input type="range" id="sfxVolume" min="0" max="1" step="0.1" value="0.3">
    </div>
  </div>

  <div class="tts-indicator" id="ttsIndicator">
    <div class="pulse"></div>
    <span>Speaking...</span>
    <button onclick="stopSpeaking()" style="background:none;border:none;color:white;cursor:pointer;font-size:1rem;">‚úï</button>
  </div>

  <div class="container">
    <div class="header">
      <h1>ü™û Snow White</h1>
      <p class="subtitle">A Structural Critique</p>
      <p class="question">"Did I really win because I was good?"</p>
    </div>
    <div id="content"></div>
    <div class="journey" id="journey"></div>
    <p class="footer">üéôÔ∏è Auto-narration ‚Ä¢ üéµ Upload BGM via settings</p>
  </div>

  <audio id="bgm" loop></audio>

  <script>
    // ========== STORY DATA ==========
    const story = {
      start: {
        type: 'narration',
        text: "The wedding bells ring. Snow White stands beside the Prince as the Queen kneels before them, awaiting punishment. The crowd cheers: 'Good has triumphed! The kind-hearted princess is finally rewarded!'<br><br>But Snow White pauses. She thinks: 'Did I really win because I was good? Or... was it something else?'",
        next: 'rewind_question'
      },
      rewind_question: {
        type: 'inner_thought',
        text: "Snow White asks herself: 'What actually saved me? My kindness... or forces beyond my control?'<br><br>Let's rewind and examine what really happened.",
        next: 'path_choice'
      },
      path_choice: {
        type: 'choice',
        question: "Choose a moment to rewind and examine:",
        options: [
          { label: "PATH A: Rewind to the moment the Prince arrived", next: 'path_a_start' },
          { label: "PATH B: Rewind to the dwarfs' cottage", next: 'path_b_start' },
          { label: "PATH C: Rewind to the Queen's first disguise", next: 'path_c_start' },
          { label: "PATH D: Rewind to the wedding ceremony", next: 'path_d_start' }
        ]
      },
      path_a_start: {
        type: 'narration',
        text: "The Prince finds Snow White's glass coffin in the forest. The dwarfs tell him: 'She was the kindest person we ever met.'<br><br>The Prince looks at her and thinks: 'She's beautiful. I'll take her to my palace.'<br><br>He orders his servants to carry the coffin. As they lift it, the poisoned apple dislodges. Snow White wakes up.",
        next: 'path_a_realization'
      },
      path_a_realization: {
        type: 'inner_thought',
        text: "Snow White wakes up and realises: 'I was saved... but not because I was good. The Prince didn't even know me. He just had the power to move my body.'<br><br>What if there was no Prince?",
        next: 'path_a_choice'
      },
      path_a_choice: {
        type: 'choice',
        question: "What if there was no Prince?",
        options: [
          { label: "A1. Stay with the dwarfs and continue being kind", next: 'path_a1_story' },
          { label: "A2. Approach a nobleman and propose a strategic marriage", next: 'path_a2_story' }
        ]
      },
      path_a1_story: {
        type: 'narration',
        text: "Years pass. Snow White cooks and cleans for the dwarfs every day. She smiles and never complains.<br><br>One day, a dwarf says: 'You're like a mother to us!' But Snow White thinks: 'I'm forty years old and still doing unpaid labour. Where is my reward?'",
        next: 'ending_a1'
      },
      ending_a1: {
        type: 'ending',
        endingType: 'critique',
        title: "Love Doesn't Pay Rent",
        text: "Snow White grows old in the dwarfs' cottage. She was good her entire life. But without political power or wealth, her goodness brought her nothing but survival.<br><br>The dwarfs loved her. But in an economy that values gold over care, her unpaid labour bought her nothing but a roof, not a future.",
        retryPoints: ['path_a_choice', 'path_choice']
      },
      path_a2_story: {
        type: 'narration',
        text: "Snow White travels to a nearby kingdom. She meets a duke and says: 'I am the King's stepdaughter. If you marry me, you gain a claim to the throne.'<br><br>The duke agrees. Not because she's kind‚Äîbecause she's politically useful.",
        next: 'convergence_power'
      },
      convergence_power: {
        type: 'convergence',
        convergenceType: 'orange',
        icon: 'üîÑ',
        title: 'CONVERGENCE POINT',
        text: "Snow White now has POWER. She is a duchess with political influence.<br><br>Having experienced powerlessness, what will she do with power?",
        options: [
          { label: "P1. Use power for personal safety only", next: 'ending_power_corrupt' },
          { label: "Continue to PATH D: The Wedding", subtext: "Use power to change the system", next: 'path_d_narration', isConvergence: true }
        ]
      },
      ending_power_corrupt: {
        type: 'ending',
        endingType: 'critique',
        title: "Becoming the Oppressor",
        text: "Snow White gives up her goodness and becomes exactly like her stepmother‚Äîusing power only for self-preservation.<br><br>She realised that in this kingdom, there is only one throne but many mirrors. To survive the structure, she had to abandon goodness and grasp power to become the oppressor.",
        retryPoints: ['convergence_power', 'path_a_choice', 'path_choice']
      },
      path_b_start: {
        type: 'narration',
        text: "The dwarfs come home from the mine. Their house is clean, and dinner is ready. They smile: 'You can stay here, Snow White!'<br><br>Snow White is grateful. But then she realises: 'Wait. I'm doing all the housework. Is this... a job? Or am I just expected to do it for free because I'm a woman?'",
        next: 'path_b_question'
      },
      path_b_question: {
        type: 'inner_thought',
        text: "Snow White thinks: 'They're protecting me. But I'm also working for them. Should I ask to be treated as an equal?'",
        next: 'path_b_choice'
      },
      path_b_choice: {
        type: 'choice',
        question: "Should Snow White ask for fair treatment?",
        options: [
          { label: "B1. Ask for a fair share of the mining profits", next: 'path_b1_story' },
          { label: "B2. Stay silent and keep working", next: 'path_b2_story' }
        ]
      },
      path_b1_story: {
        type: 'narration',
        text: "Snow White says: 'I cook, clean, and mend your clothes. I should get part of the gold you mine.'<br><br>The dwarfs look shocked. One says: 'But you're family. Family doesn't charge each other!' Another adds: 'If you want money, you can leave.'",
        next: 'convergence_betrayal'
      },
      convergence_betrayal: {
        type: 'convergence',
        convergenceType: 'red',
        icon: 'üîÑ',
        title: 'CONVERGENCE POINT',
        text: "Snow White is kicked out. Alone in the forest: 'Everyone I trusted exploited me.'<br><br>Economic betrayal leads to emotional distrust.",
        options: [
          { label: "Continue to PATH C: The Queen's Disguise", subtext: "Now suspicious of strangers...", next: 'path_c_narration', isConvergence: true }
        ]
      },
      path_b2_story: {
        type: 'narration',
        text: "Snow White says nothing. She cooks, cleans, smiles. The dwarfs praise her: 'You're so kind and selfless!'<br><br>But inside, Snow White feels hollow. 'I'm not kind. I'm just too scared to ask for what I deserve.'",
        next: 'ending_b2'
      },
      ending_b2: {
        type: 'ending',
        endingType: 'critique',
        title: "Compliance, Not Character",
        text: "Snow White survives by being 'good'‚Äîwhich means being exploitable. The system rewards compliance, not character.<br><br>Her goodness wasn't virtue. It was survival.",
        retryPoints: ['path_b_choice', 'path_choice']
      },
      path_c_start: {
        type: 'narration',
        text: "An old woman knocks: 'Pretty ribbons for sale!'<br><br>The dwarfs warned: 'Don't open the door!' But Snow White thinks: 'She's just a poor old woman. It would be rude.'<br><br>She opens the door. The Queen strangles her with the ribbon.",
        next: 'path_c_revival'
      },
      path_c_narration: {
        type: 'narration',
        text: "An old woman knocks: 'Pretty ribbons for sale!'<br><br>The dwarfs warned: 'Don't open the door!' But Snow White thinks: 'She's just a poor old woman. It would be rude.'<br><br>She opens the door. The Queen strangles her with the ribbon.",
        next: 'path_c_revival'
      },
      path_c_revival: {
        type: 'inner_thought',
        text: "The dwarfs revive her. Snow White realises: 'My kindness almost killed me. Should I stop trusting people?'",
        next: 'path_c_choice'
      },
      path_c_choice: {
        type: 'choice',
        question: "How should Snow White respond?",
        options: [
          { label: "C1. Stay kind and give people the benefit of the doubt", next: 'path_c1_story' },
          { label: "C2. Stay kind but become cautious with strangers", next: 'path_c2_story' },
          { label: "C3. Demand institutional protection from the kingdom", next: 'path_c3_story' }
        ]
      },
      path_c1_story: {
        type: 'narration',
        text: "A peasant woman knocks: 'I have a beautiful comb!'<br><br>Snow White opens the door. Poisoned again.<br><br>Later: 'Would you like an apple?'<br><br>Snow White takes it. This time, she doesn't wake up.",
        next: 'convergence_second_chance'
      },
      convergence_second_chance: {
        type: 'convergence',
        convergenceType: 'purple',
        icon: 'üîÑ',
        title: 'SECOND CHANCE',
        text: "The Prince arrives and saves her.<br><br>But THIS time, Snow White remembers what killed her: blind trust.<br><br>Will she make different choices?",
        options: [
          { label: "Continue to Convergence: Power", subtext: "She now has power through the Prince...", next: 'convergence_power', isConvergence: true }
        ]
      },
      path_c2_story: {
        type: 'narration',
        text: "Snow White still helps the dwarfs. But she locks the door to strangers.<br><br>One day, a child's voice: 'Please help! My mother is hurt!'<br><br>Impossible choice: Open the door, it might be a trap. Keep it closed, and a child might die.<br><br>She is good. She opens. It was the Queen.",
        next: 'ending_c2'
      },
      ending_c2: {
        type: 'ending',
        endingType: 'critique',
        title: "Goodness as Target",
        text: "Snow White dies.<br><br>Goodness and self-protection were incompatible. In a world where evil actively hunts you, being good means being exploitable.<br><br>The fairy tale lied: Goodness is not a shield. In a predatory system, it is a target.",
        retryPoints: ['path_c_choice', 'path_choice']
      },
      path_c3_story: {
        type: 'narration',
        text: "Snow White tells the dwarfs: 'I want to be kind. But the Queen is hunting me. The kingdom's laws should protect me.'<br><br>A dwarf laughs: 'Laws? The Queen IS the law. She's judge, jury, executioner.'<br><br>Snow White realises: no court, no police, no legal system. Only private protection.",
        next: 'ending_c3'
      },
      ending_c3: {
        type: 'ending',
        endingType: 'critique',
        title: "No Structural Justice",
        text: "Snow White hides in the forest forever. She remains kind to those she trusts. But without institutional protection, she is a permanent fugitive.<br><br>The fairy tale claimed 'goodness is rewarded,' but relied on luck and private protection. There was NO structural justice. For goodness to be rewarded, institutions must enforce justice. Otherwise, it's survival through luck.",
        retryPoints: ['path_c_choice', 'path_choice']
      },
      path_d_start: {
        type: 'narration',
        text: "Snow White stands at the altar. Everyone expects her to smile.<br><br>But she looks at the Queen kneeling. Then the Prince. Then the crowd.<br><br>She thinks: 'This whole system is broken. The Queen wasn't the problem. The monarchy was. I can't fix this by being good. I need to change the structure itself.'",
        next: 'path_d_question'
      },
      path_d_narration: {
        type: 'narration',
        text: "Snow White stands at the altar. Everyone expects her to smile.<br><br>But she looks at the Queen kneeling. Then the Prince. Then the crowd.<br><br>She thinks: 'This whole system is broken. The Queen wasn't the problem. The monarchy was. I can't fix this by being good. I need to change the structure itself.'",
        next: 'path_d_question'
      },
      path_d_question: {
        type: 'inner_thought',
        text: "Snow White asks the crowd: 'Do you want a good queen? Or do you want freedom from queens altogether?'",
        next: 'path_d_choice'
      },
      path_d_choice: {
        type: 'choice',
        question: "What kind of change should Snow White pursue?",
        options: [
          { label: "D1. Become a 'good queen' and try to reform the system", next: 'path_d1_story' },
          { label: "D2. Abolish the monarchy and create a people's council", next: 'path_d2_story' }
        ]
      },
      path_d1_story: {
        type: 'narration',
        text: "Snow White takes the throne. She bans cruel punishments. She funds orphanages. She tries to be kind.<br><br>But nobles still oppress the poor. Military crushes dissent. Her son inherits and undoes her reforms.<br><br>Too late: 'I couldn't fix the system by being inside it.'",
        next: 'ending_d1'
      },
      ending_d1: {
        type: 'ending',
        endingType: 'critique',
        title: "Individual Virtue, Structural Evil",
        text: "Snow White's goodness changed nothing. The monarchy survives. Violence continues. The next generation faces the same cruelty.<br><br>The Queen Snow White is dead, long live the Queen. Individual virtue is fragile and temporary; structural evil is durable and permanent.",
        retryPoints: ['path_d_choice', 'path_choice']
      },
      path_d2_story: {
        type: 'narration',
        text: "Snow White addresses the crowd: 'I don't want to rule you. Let's build something new‚Äîtogether.'<br><br>She works with dwarfs, peasants, servants. They dismantle the palace. Mirrors are melted into windows.<br><br>The Queen isn't punished‚Äîshe learns to see others as equals, not competitors.",
        next: 'ending_d2'
      },
      ending_d2: {
        type: 'ending',
        endingType: 'aspirational',
        title: "Structural Transformation",
        text: "It takes decades. There are setbacks. But slowly, the kingdom transforms.<br><br>'Goodness' is no longer individual virtue‚Äîit's collective care. Snow White is remembered not as 'the kindest princess,' but as the woman who refused to let kindness be a substitute for justice.",
        insight: "This is the only ending where goodness is truly rewarded‚Äîbecause the structure was changed to support it.",
        symbol: "Mirrors into Windows",
        retryPoints: ['path_d_choice', 'path_choice']
      }
    };

    const choiceLabels = {
      path_choice: "Choose Path",
      path_a_choice: "Path A Choice",
      path_b_choice: "Path B Choice",
      path_c_choice: "Path C Choice",
      path_d_choice: "Path D Choice",
      convergence_power: "Power Convergence",
      convergence_betrayal: "Betrayal Convergence"
    };

    // ========== STATE ==========
    let currentNode = 'start';
    let history = [];
    let isMuted = false;
    let bgmLoaded = false;
    let ttsEnabled = true;
    let voices = [];
    let selectedVoice = null;
    let voicesLoaded = false;

    const bgm = document.getElementById('bgm');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // ========== TTS - WEB SPEECH API ==========
    
    function getVoiceScore(voice) {
      const name = voice.name.toLowerCase();
      const lang = voice.lang.toLowerCase();
      let score = 0;
      
      // British English gets highest priority
      if (lang === 'en-gb' || lang.startsWith('en-gb') || lang === 'en_gb') score += 100;
      
      // Premium voice indicators
      if (name.includes('neural')) score += 50;
      if (name.includes('premium')) score += 40;
      if (name.includes('enhanced')) score += 30;
      if (name.includes('natural')) score += 25;
      
      // Known good British voices
      if (name.includes('daniel')) score += 60;
      if (name.includes('kate')) score += 60;
      if (name.includes('serena')) score += 55;
      if (name.includes('martha')) score += 55;
      if (name.includes('hazel')) score += 50;
      if (name.includes('george')) score += 50;
      
      // Google/Microsoft voices are generally better
      if (name.includes('google uk')) score += 70;
      if (name.includes('microsoft')) score += 40;
      if (name.includes('google')) score += 30;
      
      // Female voices often clearer for storytelling
      if (name.includes('female')) score += 10;
      
      // Any English is fallback
      if (lang.startsWith('en')) score += 5;
      
      return score;
    }

    function loadVoices() {
      voices = speechSynthesis.getVoices();
      if (voices.length === 0) return false;
      
      const voiceSelect = document.getElementById('voiceSelect');
      voiceSelect.innerHTML = '';
      
      // Filter and sort English voices
      const englishVoices = voices
        .filter(v => v.lang.startsWith('en'))
        .map(v => ({ voice: v, score: getVoiceScore(v) }))
        .sort((a, b) => b.score - a.score);
      
      if (englishVoices.length === 0) {
        document.getElementById('voiceInfo').textContent = '‚ö†Ô∏è No English voices found';
        return false;
      }
      
      // Populate dropdown
      englishVoices.forEach(({ voice }) => {
        const option = document.createElement('option');
        option.value = voices.indexOf(voice);
        const flag = voice.lang.toLowerCase().includes('gb') ? 'üá¨üáß' : 
                    voice.lang.toLowerCase().includes('au') ? 'üá¶üá∫' : 'üá∫üá∏';
        option.textContent = `${flag} ${voice.name}`;
        voiceSelect.appendChild(option);
      });
      
      // Select best voice
      const bestVoice = englishVoices[0].voice;
      selectedVoice = bestVoice;
      voiceSelect.value = voices.indexOf(bestVoice);
      
      // Update info display
      const isBritish = bestVoice.lang.toLowerCase().includes('gb');
      const flag = isBritish ? 'üá¨üáß' : bestVoice.lang.toLowerCase().includes('au') ? 'üá¶üá∫' : 'üá∫üá∏';
      const region = isBritish ? 'British' : bestVoice.lang.toLowerCase().includes('au') ? 'Australian' : 'American';
      document.getElementById('voiceInfo').innerHTML = `${flag} <strong>${region}</strong>: ${bestVoice.name}`;
      document.getElementById('voiceInfo').style.color = isBritish ? '#6ee7b7' : '#fbbf24';
      
      voicesLoaded = true;
      return true;
    }

    // Multiple attempts to load voices (browser quirk)
    function initVoices() {
      if (loadVoices()) {
        // Voices loaded, start narration
        if (ttsEnabled && currentNode === 'start') {
          setTimeout(() => speakCurrentNode(), 300);
        }
      }
    }

    // Chrome loads voices async
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = initVoices;
    }

    function stripHtml(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || '';
    }

    function speak(text) {
      if (!ttsEnabled || isMuted || !voicesLoaded) return;
      
      stopSpeaking();
      
      const cleanText = stripHtml(text);
      const utterance = new SpeechSynthesisUtterance(cleanText);
      
      // Set voice
      const voiceIndex = document.getElementById('voiceSelect').value;
      if (voices[voiceIndex]) {
        utterance.voice = voices[voiceIndex];
      } else if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      utterance.rate = parseFloat(document.getElementById('speechRate').value);
      utterance.pitch = parseFloat(document.getElementById('speechPitch').value);
      utterance.lang = selectedVoice?.lang || 'en-GB';
      
      utterance.onstart = () => {
        document.getElementById('ttsIndicator').classList.add('show');
        if (bgmLoaded) bgm.volume = parseFloat(document.getElementById('bgmVolume').value) * 0.3;
      };
      
      utterance.onend = () => {
        document.getElementById('ttsIndicator').classList.remove('show');
        if (bgmLoaded) bgm.volume = parseFloat(document.getElementById('bgmVolume').value);
      };
      
      utterance.onerror = (e) => {
        console.log('TTS Error:', e);
        document.getElementById('ttsIndicator').classList.remove('show');
        if (bgmLoaded) bgm.volume = parseFloat(document.getElementById('bgmVolume').value);
      };
      
      speechSynthesis.speak(utterance);
    }

    function stopSpeaking() {
      speechSynthesis.cancel();
      document.getElementById('ttsIndicator').classList.remove('show');
      if (bgmLoaded) bgm.volume = parseFloat(document.getElementById('bgmVolume').value);
    }

    function speakCurrentNode() {
      const node = story[currentNode];
      if (!node || !ttsEnabled || !voicesLoaded) return;
      
      let narrateText = '';
      
      if (node.type === 'narration' || node.type === 'inner_thought') {
        narrateText = node.text;
      } else if (node.type === 'choice') {
        narrateText = node.question + '. ' + node.options.map((o, i) => `Option ${i+1}: ${stripHtml(o.label)}`).join('. ');
      } else if (node.type === 'convergence') {
        narrateText = node.title + '. ' + node.text;
      } else if (node.type === 'ending') {
        const isAsp = node.endingType === 'aspirational';
        narrateText = (isAsp ? 'Aspirational Ending: ' : 'Structural Critique: ') + node.title + '. ' + node.text;
        if (node.insight) narrateText += ' Key insight: ' + node.insight;
      }
      
      if (narrateText) speak(narrateText);
    }

    // ========== SOUND EFFECTS ==========
    function playTone(freq, dur, type = 'sine', vol = 0.3) {
      if (isMuted) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.frequency.value = freq; osc.type = type;
      const sfxVol = parseFloat(document.getElementById('sfxVolume').value);
      gain.gain.setValueAtTime(vol * sfxVol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
      osc.start(); osc.stop(audioCtx.currentTime + dur);
    }

    function playClick() { playTone(800, 0.1, 'sine', 0.2); setTimeout(() => playTone(1000, 0.1, 'sine', 0.15), 50); }
    function playChoice() { playTone(400, 0.15, 'triangle', 0.3); setTimeout(() => playTone(500, 0.15, 'triangle', 0.25), 100); setTimeout(() => playTone(600, 0.2, 'triangle', 0.2), 200); }
    function playGoodEnding() { [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playTone(f, 0.3, 'sine', 0.25), i * 150)); }
    function playDarkEnding() { playTone(200, 0.5, 'sawtooth', 0.2); setTimeout(() => playTone(150, 0.5, 'sawtooth', 0.15), 300); setTimeout(() => playTone(100, 0.6, 'sawtooth', 0.1), 600); }
    function playInnerThought() { playTone(600, 0.4, 'sine', 0.1); setTimeout(() => playTone(650, 0.3, 'sine', 0.08), 200); }
    function playConvergence() { playTone(330, 0.2, 'triangle', 0.3); setTimeout(() => playTone(440, 0.2, 'triangle', 0.25), 150); setTimeout(() => playTone(550, 0.3, 'triangle', 0.2), 300); }

    // ========== RENDER ==========
    function render(autoSpeak = true) {
      const node = story[currentNode];
      const content = document.getElementById('content');
      let html = '';

      if (node.type === 'narration') {
        html = `
          <div class="card">
            <div class="label narration">üìñ Story</div>
            <p class="text">${node.text}</p>
            <button class="btn btn-primary" onclick="goNext('${node.next}')">Continue ‚Üí</button>
          </div>`;
      }
      else if (node.type === 'inner_thought') {
        html = `
          <div class="card inner-thought">
            <div class="label thought">üí≠ Snow White's Thoughts</div>
            <p class="text italic">${node.text}</p>
            <button class="btn btn-primary" onclick="goNext('${node.next}')">Continue ‚Üí</button>
          </div>`;
        playInnerThought();
      }
      else if (node.type === 'choice') {
        let optionsHtml = node.options.map(opt => `
          <button class="btn btn-choice" onclick="makeChoice('${opt.next}')">
            <div>${opt.label}</div>
            ${opt.subtext ? `<div class="subtext">${opt.subtext}</div>` : ''}
          </button>`).join('');
        html = `
          <div class="card choice">
            <div class="label decision">‚öîÔ∏è Decision Point</div>
            <p class="text">${node.question}</p>
            ${optionsHtml}
          </div>`;
      }
      else if (node.type === 'convergence') {
        const colorClass = node.convergenceType === 'red' ? 'convergence-red' : 
                          node.convergenceType === 'purple' ? 'convergence-purple' : 'convergence';
        const labelClass = node.convergenceType === 'red' ? 'convergence-red' : 
                          node.convergenceType === 'purple' ? 'convergence-purple' : 'convergence';
        
        let optionsHtml = node.options.map(opt => `
          <button class="btn ${opt.isConvergence ? 'btn-convergence' : 'btn-choice'}" onclick="makeChoice('${opt.next}')">
            <div>${opt.label}</div>
            ${opt.subtext ? `<div class="subtext">${opt.subtext}</div>` : ''}
          </button>`).join('');

        html = `
          <div class="card ${colorClass}">
            <div class="label ${labelClass}">${node.icon} ${node.title}</div>
            <p class="text">${node.text}</p>
            ${optionsHtml}
          </div>`;
        playConvergence();
      }
      else if (node.type === 'ending') {
        const isAsp = node.endingType === 'aspirational';
        let retryBtns = node.retryPoints.map(p => `<button class="btn btn-ghost btn-small" onclick="retry('${p}')">‚Ü© ${choiceLabels[p] || p}</button>`).join('');
        
        html = `
          <div class="card ending-${node.endingType}">
            <div class="framework-badge ${node.endingType}">
              <span class="icon">${isAsp ? '‚ú®' : 'üíî'}</span>
              <div>
                <div class="name">${isAsp ? 'ASPIRATIONAL ENDING' : 'STRUCTURAL CRITIQUE'}</div>
                <div class="subtitle">${node.title}</div>
              </div>
            </div>
            
            <p class="text">${node.text}</p>

            ${node.insight ? `
              <div class="insight-box">
                <div class="i-label">Key Insight</div>
                <div class="i-text">${node.insight}</div>
              </div>
            ` : ''}

            ${node.symbol ? `
              <div style="text-align: center; margin: 16px 0; padding: 12px; background: rgba(16,185,129,0.1); border-radius: 8px; border: 1px solid rgba(52,211,153,0.3);">
                <div style="font-size: 1.1rem; color: #a7f3d0;">ü™û ${node.symbol}</div>
              </div>
            ` : ''}

            ${!isAsp ? `
              <div class="critique-box">
                <div class="c-label">Structural Critique</div>
                <div class="c-text">The fairy tale's promise‚Äî"goodness is rewarded"‚Äîfails under examination. Without structural change, individual virtue remains vulnerable to exploitation.</div>
              </div>
            ` : ''}

            <div class="divider"></div>
            <div class="retry-section">
              <p>Explore other paths:</p>
              ${retryBtns}
              <button class="btn btn-ghost" onclick="restart()">üîÑ Start Over</button>
            </div>
          </div>`;
        
        if (isAsp) playGoodEnding(); else playDarkEnding();
      }

      content.innerHTML = html;
      updateJourney();
      
      if (autoSpeak && ttsEnabled) {
        setTimeout(() => speakCurrentNode(), 300);
      }
    }

    function goNext(nextId) {
      playClick();
      stopSpeaking();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      if (bgmLoaded && bgm.paused && !isMuted) bgm.play();
      history.push(currentNode);
      currentNode = nextId;
      render();
    }

    function makeChoice(nextId) {
      playChoice();
      stopSpeaking();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      if (bgmLoaded && bgm.paused && !isMuted) bgm.play();
      history.push(currentNode);
      currentNode = nextId;
      render();
    }

    function retry(point) {
      playClick();
      stopSpeaking();
      const idx = history.indexOf(point);
      history = idx !== -1 ? history.slice(0, idx) : [];
      currentNode = point;
      render();
    }

    function restart() {
      playClick();
      stopSpeaking();
      history = [];
      currentNode = 'start';
      render();
    }

    function updateJourney() {
      const journey = document.getElementById('journey');
      if (history.length === 0) { journey.innerHTML = ''; return; }
      const icons = history.slice(-6).map(h => {
        const t = story[h]?.type;
        const icon = t === 'choice' ? '‚öîÔ∏è' : t === 'inner_thought' ? 'üí≠' : t === 'ending' ? 'üèÅ' : t === 'convergence' ? 'üîÑ' : 'üìñ';
        return `<span class="journey-item">${icon}</span>`;
      }).join('');
      journey.innerHTML = `<span>Journey:</span> ${icons}`;
    }

    // ========== AUDIO CONTROLS ==========
    document.getElementById('ttsBtn').onclick = () => {
      ttsEnabled = !ttsEnabled;
      document.getElementById('ttsBtn').classList.toggle('active', ttsEnabled);
      if (ttsEnabled) {
        speakCurrentNode();
      } else {
        stopSpeaking();
      }
    };

    document.getElementById('muteBtn').onclick = () => {
      isMuted = !isMuted;
      document.getElementById('muteBtn').textContent = isMuted ? 'üîá' : 'üîä';
      if (isMuted) {
        bgm.pause();
        stopSpeaking();
      } else if (bgmLoaded) {
        bgm.play();
      }
    };

    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('audioPanel').classList.toggle('show');
    };

    document.getElementById('bgmInput').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        bgm.src = URL.createObjectURL(file);
        bgm.load();
        bgmLoaded = true;
        document.getElementById('musicStatus').textContent = 'üéµ ' + file.name;
        document.getElementById('musicStatus').classList.add('loaded');
        if (!isMuted) bgm.play();
      }
    };

    document.getElementById('bgmVolume').oninput = (e) => { bgm.volume = e.target.value; };
    document.getElementById('speechRate').oninput = (e) => { 
      document.getElementById('rateValue').textContent = e.target.value;
    };
    document.getElementById('speechPitch').oninput = (e) => { 
      document.getElementById('pitchValue').textContent = e.target.value;
    };
    document.getElementById('voiceSelect').onchange = (e) => {
      const idx = e.target.value;
      if (voices[idx]) {
        selectedVoice = voices[idx];
        const isBritish = selectedVoice.lang.toLowerCase().includes('gb');
        const flag = isBritish ? 'üá¨üáß' : selectedVoice.lang.toLowerCase().includes('au') ? 'üá¶üá∫' : 'üá∫üá∏';
        const region = isBritish ? 'British' : selectedVoice.lang.toLowerCase().includes('au') ? 'Australian' : 'American';
        document.getElementById('voiceInfo').innerHTML = `${flag} <strong>${region}</strong>: ${selectedVoice.name}`;
        document.getElementById('voiceInfo').style.color = isBritish ? '#6ee7b7' : '#fbbf24';
      }
    };

    // ========== STARS ==========
    function createStars() {
      const container = document.getElementById('stars');
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        container.appendChild(star);
      }
    }

    // ========== INIT ==========
    createStars();
    render(false); // Don't auto-speak yet
    
    // Try to load voices immediately (Firefox)
    initVoices();
    
    // Retry voice loading (some browsers need delay)
    setTimeout(() => {
      if (!voicesLoaded) initVoices();
    }, 100);
    setTimeout(() => {
      if (!voicesLoaded) initVoices();
    }, 500);
    setTimeout(() => {
      if (!voicesLoaded) initVoices();
    }, 1000);
    
    bgm.src = 'bgm.mp3';
    bgm.volume = 0.15;
    bgm.oncanplaythrough = () => {
      bgmLoaded = true;
      document.getElementById('musicStatus').textContent = 'üéµ bgm.mp3 loaded';
      document.getElementById('musicStatus').classList.add('loaded');
    };
    bgm.onerror = () => { console.log('üí° Add bgm.mp3 for background music'); };
  </script>
</body>
</html>
