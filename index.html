<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snow White - Interactive Tale with Audio</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
    .font-serif { font-family: 'Crimson Text', serif; }
    
    /* Audio visualizer animation */
    @keyframes soundWave {
      0%, 100% { height: 4px; }
      50% { height: 16px; }
    }
    .sound-wave {
      animation: soundWave 0.5s ease-in-out infinite;
    }
    .sound-wave:nth-child(2) { animation-delay: 0.1s; }
    .sound-wave:nth-child(3) { animation-delay: 0.2s; }
    .sound-wave:nth-child(4) { animation-delay: 0.3s; }
    .sound-wave:nth-child(5) { animation-delay: 0.4s; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // ===== AUDIO MANAGER =====
    class AudioManager {
      constructor() {
        this.bgMusic = null;
        this.sounds = {};
        this.isMuted = false;
        this.bgVolume = 0.3;
        this.sfxVolume = 0.5;
        this.speechSynth = window.speechSynthesis;
        this.currentUtterance = null;
        this.isNarrating = false;
        
        // Initialize background music
        this.initBgMusic();
        
        // Initialize sound effects
        this.initSoundEffects();
      }

      initBgMusic() {
        // Using a free fantasy ambient track
        this.bgMusic = new Audio('https://cdn.pixabay.com/download/audio/2022/10/25/audio_946b0939c8.mp3?filename=medieval-fantasy-142897.mp3');
        this.bgMusic.loop = true;
        this.bgMusic.volume = this.bgVolume;
      }

      initSoundEffects() {
        // Create oscillator-based sound effects (no external files needed)
        this.audioContext = null;
        try {
          this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
          console.log('Web Audio API not supported');
        }
      }

      // Generate sound effects using Web Audio API
      playTone(frequency, duration, type = 'sine', volume = 0.3) {
        if (this.isMuted || !this.audioContext) return;
        
        // Resume audio context if suspended
        if (this.audioContext.state === 'suspended') {
          this.audioContext.resume();
        }

        const oscillator = this.audioContext.createOscillator();
        const gainNode = this.audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(this.audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = type;
        
        gainNode.gain.setValueAtTime(volume * this.sfxVolume, this.audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
        
        oscillator.start(this.audioContext.currentTime);
        oscillator.stop(this.audioContext.currentTime + duration);
      }

      // Sound effect presets
      playClick() {
        this.playTone(800, 0.1, 'sine', 0.2);
        setTimeout(() => this.playTone(1000, 0.1, 'sine', 0.15), 50);
      }

      playChoice() {
        this.playTone(400, 0.15, 'triangle', 0.3);
        setTimeout(() => this.playTone(500, 0.15, 'triangle', 0.25), 100);
        setTimeout(() => this.playTone(600, 0.2, 'triangle', 0.2), 200);
      }

      playTransition() {
        this.playTone(300, 0.3, 'sine', 0.2);
        setTimeout(() => this.playTone(400, 0.3, 'sine', 0.15), 150);
      }

      playDarkEnding() {
        this.playTone(200, 0.5, 'sawtooth', 0.2);
        setTimeout(() => this.playTone(150, 0.5, 'sawtooth', 0.15), 300);
        setTimeout(() => this.playTone(100, 0.8, 'sawtooth', 0.1), 600);
      }

      playGoodEnding() {
        const notes = [523, 659, 784, 1047]; // C5, E5, G5, C6
        notes.forEach((freq, i) => {
          setTimeout(() => this.playTone(freq, 0.3, 'sine', 0.25), i * 150);
        });
      }

      playInnerThought() {
        this.playTone(600, 0.4, 'sine', 0.1);
        setTimeout(() => this.playTone(650, 0.3, 'sine', 0.08), 200);
      }

      // Background music controls
      async playBgMusic() {
        if (this.isMuted) return;
        try {
          this.bgMusic.volume = this.bgVolume;
          await this.bgMusic.play();
        } catch (e) {
          console.log('Background music autoplay blocked, will play on interaction');
        }
      }

      pauseBgMusic() {
        this.bgMusic.pause();
      }

      setBgVolume(volume) {
        this.bgVolume = volume;
        if (this.bgMusic) {
          this.bgMusic.volume = volume;
        }
      }

      setSfxVolume(volume) {
        this.sfxVolume = volume;
      }

      // Voice narration using Web Speech API
      speak(text, onEnd = null) {
        if (this.isMuted || !this.speechSynth) return;
        
        // Cancel any ongoing speech
        this.stopSpeaking();
        
        this.currentUtterance = new SpeechSynthesisUtterance(text);
        this.currentUtterance.rate = 0.9;
        this.currentUtterance.pitch = 1;
        this.currentUtterance.volume = 0.8;
        
        // Try to use a female English voice
        const voices = this.speechSynth.getVoices();
        const preferredVoice = voices.find(v => 
          v.lang.includes('en') && v.name.toLowerCase().includes('female')
        ) || voices.find(v => v.lang.includes('en-US')) || voices[0];
        
        if (preferredVoice) {
          this.currentUtterance.voice = preferredVoice;
        }

        this.currentUtterance.onstart = () => {
          this.isNarrating = true;
        };

        this.currentUtterance.onend = () => {
          this.isNarrating = false;
          if (onEnd) onEnd();
        };

        this.currentUtterance.onerror = () => {
          this.isNarrating = false;
        };

        this.speechSynth.speak(this.currentUtterance);
      }

      stopSpeaking() {
        if (this.speechSynth) {
          this.speechSynth.cancel();
        }
        this.isNarrating = false;
      }

      toggleMute() {
        this.isMuted = !this.isMuted;
        if (this.isMuted) {
          this.pauseBgMusic();
          this.stopSpeaking();
        } else {
          this.playBgMusic();
        }
        return this.isMuted;
      }
    }

    // Create global audio manager instance
    const audioManager = new AudioManager();

    // ===== STORY DATA =====
    const storyData = {
      prologue: {
        id: 'prologue',
        type: 'prologue',
        text: "Before we begin, consider this puzzle:",
        puzzle: "In the original Grimm fairy tale, Snow White‚Äîthe symbol of pure goodness‚Äîwatches silently as the Queen is forced to dance in red-hot iron shoes until she dies. She does not intervene. She does not show mercy. Why?",
        next: 'prologue2'
      },
      prologue2: {
        id: 'prologue2',
        type: 'narration',
        text: "Perhaps her 'goodness' was never what it seemed. In the fairy tale's absolute monarchy, the Queen stood above all laws. Three times she tried to kill Snow White‚Äîthrough the huntsman, the poisoned comb, and the poisoned apple‚Äîand no court could stop her.",
        next: 'prologue3'
      },
      prologue3: {
        id: 'prologue3',
        type: 'narration',
        text: "When you have no legal protection, no power, no allies‚Äîwhat choice do you have but to be 'good'? Kindness becomes survival. Gentleness becomes strategy. And perhaps, deep inside, you dream of the day when the positions will be reversed...",
        next: 'start'
      },
      start: {
        id: 'start',
        type: 'narration',
        text: "Once upon a time... Snow White fled from the kingdom to escape the jealous Queen. She survived three assassination attempts. She was poisoned, left for dead, and saved only by chance‚Äîa prince's kiss. Now, she is about to marry that prince. And the Queen who tormented her kneels before her, awaiting judgment.",
        next: 'scene1'
      },
      scene1: {
        id: 'scene1',
        type: 'narration',
        text: "The Queen enters the grand hall. Hundreds watch in silence. For years, this woman held absolute power‚Äîabove the law, above morality, above consequence. Now she kneels before the girl she tried to destroy.",
        next: 'inner1'
      },
      inner1: {
        id: 'inner1',
        type: 'inner_thought',
        text: "Snow White feels something unfamiliar rising in her chest. Is it justice? Satisfaction? Or something she's been suppressing for years‚Äîever since the day she learned that being 'good' was the only way to survive?",
        next: 'scene2'
      },
      scene2: {
        id: 'scene2',
        type: 'narration',
        text: 'The Prince leans close and whispers: "You were her victim. No court could touch her then‚Äîbut now, you ARE the court. The choice is yours."',
        next: 'inner2'
      },
      inner2: {
        id: 'inner2',
        type: 'inner_thought',
        text: "For the first time in her life, Snow White holds power over someone who once held power over her. All those years of smiling through fear, of being gentle because fighting back meant death‚Äîwas that goodness? Or was it just... waiting?",
        next: 'choice1'
      },
      choice1: {
        id: 'choice1',
        type: 'choice',
        question: "The power dynamics have completely reversed. What will Snow White do?",
        context: "This is the moment that will reveal whether her 'goodness' was a genuine virtue‚Äîor a survival strategy that is no longer needed.",
        options: [
          { label: "A. Give the order to start the punishment", subtext: "Finally, she can make the Queen pay for everything", next: 'punish1' },
          { label: "B. Interrogate the Queen first", subtext: "Before judgment, she wants to understand", next: 'interrogate1' }
        ]
      },
      
      // PUNISHMENT PATH
      punish1: {
        id: 'punish1',
        type: 'narration',
        text: 'The crowd erupts: "Burn her! Make her suffer!" The Prince nods approvingly: "Just give the word. I\'ll handle everything."',
        next: 'punish_inner1'
      },
      punish_inner1: {
        id: 'punish_inner1',
        type: 'inner_thought',
        text: "Snow White remembers hiding in the forest, terrified, starving, with no one to protect her. She remembers the huntsman's knife, the poisoned comb burning her scalp, the apple lodged in her throat. All those times she had to smile, to be kind, to never show anger‚Äîbecause anger would have gotten her killed.",
        next: 'punish_inner2'
      },
      punish_inner2: {
        id: 'punish_inner2',
        type: 'inner_thought',
        text: "But now? Now SHE is the one with power. Now SHE decides who lives and dies. The 'goodness' that protected her is no longer necessary. So what is she, really, without it?",
        next: 'choice2'
      },
      choice2: {
        id: 'choice2',
        type: 'choice',
        question: "The law decrees death by dancing in hot-iron shoes. What should Snow White do?",
        context: "Will her goodness survive now that she no longer needs it for protection?",
        options: [
          { label: "A. Nod coldly‚Äîthis is politically necessary", subtext: "Remove the threat. Secure the throne. Feel nothing.", next: 'machiavelli_path1' },
          { label: "B. Demand a harder punishment", subtext: "She deserves to suffer as I suffered", next: 'cynicism_path1' }
        ]
      },
      
      // MACHIAVELLIAN PATH
      machiavelli_path1: {
        id: 'machiavelli_path1',
        type: 'narration',
        text: "Snow White nods once, her face expressionless. She feels no hatred, no satisfaction‚Äîonly a cold calculation. The Queen must die, not because Snow White wants vengeance, but because leaving her alive would destabilize the new regime.",
        next: 'machiavelli_inner1'
      },
      machiavelli_inner1: {
        id: 'machiavelli_inner1',
        type: 'inner_thought',
        text: "Is this who I really am? Or is this who power makes me become? When I was weak, I was kind because I had to be. Now that I'm strong... kindness is a luxury I can no longer afford.",
        next: 'machiavelli_path2'
      },
      machiavelli_path2: {
        id: 'machiavelli_path2',
        type: 'narration',
        text: "The Prince watches her with new eyes‚Äîrespect mixed with unease. 'You've changed,' he says. Snow White replies without looking at him: 'I've learned. Power requires sacrifices that goodness cannot make.'",
        next: 'choice_machiavelli'
      },
      choice_machiavelli: {
        id: 'choice_machiavelli',
        type: 'choice',
        question: "The Queen's allies still remain at court. They could become future threats. What should Snow White do?",
        context: "Structural necessity vs. moral restraint‚Äîwhich will define her reign?",
        options: [
          { label: "A. Purge them all", subtext: "Eliminate every possible threat before it grows", next: 'ending_machiavelli_full' },
          { label: "B. Show calculated mercy", subtext: "Keep them alive but watched‚Äîuseful pawns", next: 'ending_machiavelli_moderate' }
        ]
      },
      ending_machiavelli_full: {
        id: 'ending_machiavelli_full',
        type: 'ending',
        framework: 'machiavellian',
        endingType: 'dark',
        text: "Snow White executes the Queen and exiles all her supporters. She feels no joy, no guilt‚Äîonly the cold weight of necessity. Her kingdom prospers under firm rule, but she sleeps alone, surrounded by fear rather than love.",
        analysis: "Snow White's 'good heart' was revealed as a behavioral adaptation to powerlessness. Her goodness was never a fixed internal virtue; it was a rational response to being the 'absolute weak party.'",
        retryPoints: ['choice2', 'choice1']
      },
      ending_machiavelli_moderate: {
        id: 'ending_machiavelli_moderate',
        type: 'ending',
        framework: 'machiavellian',
        endingType: 'neutral',
        text: "Snow White spares the Queen's allies but keeps them under constant surveillance. She rules with pragmatism‚Äîneither cruel nor kind, but always strategic. Trust becomes a currency she can no longer spend freely.",
        analysis: "A moderate expression of Machiavellian Realism. Snow White's goodness partially survives, but it has been transformed from a moral essence into a political tool.",
        retryPoints: ['choice_machiavelli', 'choice2', 'choice1']
      },

      // CYNICISM PATH
      cynicism_path1: {
        id: 'cynicism_path1',
        type: 'narration',
        text: "Snow White's voice comes out cold and sharp: 'Make the shoes hotter. Make her dance longer.' The guards hesitate‚Äîthis is not the gentle princess from the stories. But they obey.",
        next: 'cynicism_inner1'
      },
      cynicism_inner1: {
        id: 'cynicism_inner1',
        type: 'inner_thought',
        text: "All those years of being 'good.' All those years of smiling when she wanted to scream, of forgiving when she wanted revenge. Was it virtue? Or was it just weakness dressed up as morality?",
        next: 'cynicism_path2'
      },
      cynicism_path2: {
        id: 'cynicism_path2',
        type: 'narration',
        text: "The Queen screams. The crowd cheers. And Snow White watches with an expression she doesn't recognize‚Äîbecause she's never been allowed to wear it before. Satisfaction. Power. The same dark hunger that once burned in the Queen's eyes.",
        next: 'cynicism_inner2'
      },
      cynicism_inner2: {
        id: 'cynicism_inner2',
        type: 'inner_thought',
        text: "Perhaps this was always inside me. Perhaps 'goodness' was just a cage I built to survive‚Äîand now that the cage is open, I'm finally free to be what I always was.",
        next: 'choice_cynicism'
      },
      choice_cynicism: {
        id: 'choice_cynicism',
        type: 'choice',
        question: "The Prince looks disturbed. 'Snow White, this is enough.' The Queen is barely alive, pleading for mercy.",
        context: "The mirror of power reflects back a face Snow White doesn't recognize. Or does she?",
        options: [
          { label: "A. Stop‚Äîhorrified by what she's becoming", subtext: "This isn't who I want to be", next: 'ending_cynicism_aware' },
          { label: "B. Continue until the end", subtext: "She deserves every moment of pain", next: 'ending_cynicism_full' }
        ]
      },
      ending_cynicism_aware: {
        id: 'ending_cynicism_aware',
        type: 'ending',
        framework: 'dogma',
        endingType: 'tragic',
        text: "Snow White raises her hand‚Äî'Stop.' But it's too late. The Queen dies from her wounds moments later. Snow White stares at her own hands, trembling. For years she believed she was good. Now she knows the truth.",
        analysis: "This ending embodies the Dogma/Cynicism framework's core claim: goodness is an illusion. The weak are not virtuous; they simply lack the power to be cruel.",
        retryPoints: ['choice_cynicism', 'choice2', 'choice1']
      },
      ending_cynicism_full: {
        id: 'ending_cynicism_full',
        type: 'ending',
        framework: 'dogma',
        endingType: 'dark',
        text: "The Queen dies in atrocious agony while Snow White watches without blinking. From that day forward, executions become daily spectacles. She chose to become the hammer. In her private moments, she laughs bitterly at the old stories‚Äîthe ones that called her 'good.'",
        analysis: "The darkest expression of Dogma/Cynicism. The victim has become the victimizer, revealing that 'goodness' in asymmetrical power structures is merely a tactic of the weak.",
        retryPoints: ['choice_cynicism', 'choice2', 'choice1']
      },

      // INTERROGATION PATH
      interrogate1: {
        id: 'interrogate1',
        type: 'narration',
        text: 'Snow White raises her hand, and the chanting crowd falls silent. Instead of passing judgment, she asks: "Before anything else‚ÄîI want to understand. Why did you try to kill me? Three times. Why?"',
        next: 'interrogate_inner1'
      },
      interrogate_inner1: {
        id: 'interrogate_inner1',
        type: 'inner_thought',
        text: "Is she stalling? Showing weakness? Or is this something else‚Äîa genuine desire to understand that goes beyond survival calculation? For the first time, Snow White isn't acting from fear or strategy. She's acting from... curiosity?",
        next: 'interrogate2'
      },
      interrogate2: {
        id: 'interrogate2',
        type: 'narration',
        text: 'The Queen looks up, surprised by the question no one expected. "I was... jealous. I felt so alone in this palace. I thought everyone would abandon me for you. Your beauty made me feel worthless."',
        next: 'interrogate_inner2'
      },
      interrogate_inner2: {
        id: 'interrogate_inner2',
        type: 'inner_thought',
        text: "Snow White hears something in those words‚Äînot an excuse, but a familiar pain. Loneliness. Fear. The desperate need to survive in a world that measured worth by surfaces. Had the Queen once been a frightened girl too?",
        next: 'choice_interrogate1'
      },
      choice_interrogate1: {
        id: 'choice_interrogate1',
        type: 'choice',
        question: "Snow White has received an answer. But is it the complete truth?",
        context: "She could stop here and pass judgment. Or she could dig deeper.",
        options: [
          { label: "A. Accept her reason and show mercy", subtext: "Let cosmic justice decide her fate", next: 'karma_path1' },
          { label: "B. Keep questioning‚Äîthere must be a deeper cause", subtext: "Jealousy doesn't appear from nowhere", next: 'emotionalism_path1' }
        ]
      },

      // KARMA PATH
      karma_path1: {
        id: 'karma_path1',
        type: 'narration',
        text: "Snow White nods slowly. 'I understand jealousy. I understand loneliness. I will not add more suffering to this world.' She orders the Queen banished to the forest‚Äîalive, but exiled forever.",
        next: 'karma_inner1'
      },
      karma_inner1: {
        id: 'karma_inner1',
        type: 'inner_thought',
        text: "Is this mercy? Or is it simply passing the responsibility to a higher power? Snow White isn't certain if she's being virtuous or just... tired. Tired of the cycle of cruelty that defined her childhood.",
        next: 'karma_path2'
      },
      karma_path2: {
        id: 'karma_path2',
        type: 'narration',
        text: "The crowd murmurs in confusion. The Prince asks: 'Is this justice?' Snow White replies: 'Justice is not mine alone to give. The universe balances all debts‚Äîin this life or the next.'",
        next: 'choice_karma'
      },
      choice_karma: {
        id: 'choice_karma',
        type: 'choice',
        question: "Years pass. The Queen lives alone in the forest. What do you believe happened to her?",
        context: "This choice reveals your view of cosmic justice.",
        options: [
          { label: "A. She paid for her sins through loneliness", subtext: "Karma found her in the end", next: 'ending_karma_natural' },
          { label: "B. She never changed‚Äîand my children are in danger", subtext: "Some people cannot be redeemed", next: 'ending_karma_cycle' }
        ]
      },
      ending_karma_natural: {
        id: 'ending_karma_natural',
        type: 'ending',
        framework: 'karma',
        endingType: 'bittersweet',
        text: "The Queen dies alone in the forest, never finding the love she desperately sought. When Snow White hears the news, she feels a complex mixture of sadness and peace. She chose not to become the instrument of vengeance.",
        analysis: "This ending represents Karma/Religious Cosmology. Snow White maintains her moral identity by outsourcing punishment to the universe.",
        retryPoints: ['choice_karma', 'choice_interrogate1', 'choice1']
      },
      ending_karma_cycle: {
        id: 'ending_karma_cycle',
        type: 'ending',
        framework: 'karma',
        endingType: 'tragic',
        text: "Years later, Snow White's daughter wanders into the forest and meets a kind old woman offering a beautiful comb. The Queen never changed. The cycle of jealousy and violence continues into the next generation.",
        analysis: "A tragic subversion of Karma. Snow White's faith in cosmic justice was misplaced‚Äîthe Queen's karma did not manifest in this lifetime.",
        retryPoints: ['choice_karma', 'choice_interrogate1', 'choice1']
      },

      // EMOTIONALISM PATH
      emotionalism_path1: {
        id: 'emotionalism_path1',
        type: 'narration',
        text: '"No," Snow White says firmly. "Jealousy doesn\'t appear from nowhere. Who taught you that your worth depends on being the fairest? What‚Äîor who‚Äîmade you believe that beauty was everything?"',
        next: 'emotionalism_inner1'
      },
      emotionalism_inner1: {
        id: 'emotionalism_inner1',
        type: 'inner_thought',
        text: "Snow White is doing something she's never done before‚Äînot surviving, not adapting, not calculating. She's genuinely trying to understand another person's pain. For the first time, her actions aren't shaped by fear or strategy. They're shaped by... choice.",
        next: 'emotionalism_path2'
      },
      emotionalism_path2: {
        id: 'emotionalism_path2',
        type: 'narration',
        text: 'The Queen\'s eyes fill with tears. Slowly, she points at the ornate mirrors lining the walls. "It was them... the magic mirror. Every day it told me who was fairest. Every day I lived in terror of the answer changing."',
        next: 'emotionalism_inner2'
      },
      emotionalism_inner2: {
        id: 'emotionalism_inner2',
        type: 'inner_thought',
        text: "Snow White sees it now‚Äîthe Queen was also a victim. A victim of a system that reduced women's worth to appearance. A victim of a world that taught competition instead of compassion. The Queen wasn't born evil. She was made.",
        next: 'emotionalism_path3'
      },
      emotionalism_path3: {
        id: 'emotionalism_path3',
        type: 'narration',
        text: "Snow White looks at the mirrors‚Äîdozens of them, reflecting endless images of herself. For years, she was praised for her beauty. But what would she have become if a mirror had whispered, every day, that she wasn't enough?",
        next: 'choice_emotionalism'
      },
      choice_emotionalism: {
        id: 'choice_emotionalism',
        type: 'choice',
        question: "Snow White now sees the full picture‚Äîthe Queen, the mirrors, the system that created them both.",
        context: "True moral transformation requires addressing both the symptom and the cause.",
        options: [
          { label: "A. Forgive the Queen but keep the mirrors", subtext: "Personal reconciliation is enough", next: 'ending_emotionalism_incomplete' },
          { label: "B. Destroy the mirrors but remain angry", subtext: "Fix the system, but I cannot forgive her", next: 'ending_emotionalism_partial' },
          { label: "C. Forgive the Queen AND destroy the mirrors", subtext: "Address both the person and the structure", next: 'ending_emotionalism_full' }
        ]
      },
      ending_emotionalism_incomplete: {
        id: 'ending_emotionalism_incomplete',
        type: 'ending',
        framework: 'emotionalism',
        endingType: 'bittersweet',
        text: "Snow White embraces the Queen, and they begin to heal together. But the mirrors remain. Years later, Snow White catches herself asking a mirror who is fairest‚Äîand feels a familiar anxiety when she notices her first wrinkle.",
        analysis: "An incomplete expression of Moral Idealism. Snow White's forgiveness was genuine, but by failing to address the structural cause, she left the disease untreated.",
        retryPoints: ['choice_emotionalism', 'choice_interrogate1', 'choice1']
      },
      ending_emotionalism_partial: {
        id: 'ending_emotionalism_partial',
        type: 'ending',
        framework: 'emotionalism',
        endingType: 'neutral',
        text: "Snow White orders every mirror in the kingdom destroyed. No one will ever again be told they must be 'the fairest.' But she cannot forgive the Queen. Snow White's reign is just‚Äîbut her heart remains scarred.",
        analysis: "A partial victory for Moral Idealism. She transcended survival strategy but could not fully achieve moral transformation.",
        retryPoints: ['choice_emotionalism', 'choice_interrogate1', 'choice1']
      },
      ending_emotionalism_full: {
        id: 'ending_emotionalism_full',
        type: 'ending',
        framework: 'emotionalism',
        endingType: 'best',
        text: "Snow White takes the Queen's hands and helps her stand. Together, they walk to the great mirror and shatter it. Every mirror in the kingdom is replaced with windows‚Äîsymbols of looking outward, not inward. The Queen becomes a teacher. And Snow White rules not because she has to be 'good' to survive, but because she chooses to be‚Äîfreely, without fear.",
        analysis: "The fullest expression of Emotionalism/Moral Idealism. Her goodness was not an illusion; it was a seed that, once freed from the soil of fear, could finally bloom.",
        retryPoints: ['choice_emotionalism', 'choice_interrogate1', 'choice1']
      }
    };

    const frameworkInfo = {
      emotionalism: { name: "Emotionalism / Moral Idealism", subtitle: "Goodness as Internal Virtue", color: "emerald", icon: "üíö" },
      karma: { name: "Karma / Religious Cosmology", subtitle: "Goodness as Cosmic Balance", color: "violet", icon: "‚òØÔ∏è" },
      dogma: { name: "Dogma / Cynicism", subtitle: "Goodness as Illusion", color: "red", icon: "üé≠" },
      machiavellian: { name: "Machiavellian Realism", subtitle: "Goodness as Political Performance", color: "slate", icon: "üëë" }
    };

    const choiceLabels = {
      choice1: "The First Choice",
      choice2: "The Punishment",
      choice_machiavelli: "Political Necessity",
      choice_cynicism: "The Abyss",
      choice_interrogate1: "Seeking Understanding",
      choice_karma: "Cosmic Justice",
      choice_emotionalism: "The Root Cause"
    };

    // ===== AUDIO CONTROLS COMPONENT =====
    function AudioControls({ audioManager, isNarrating, onNarrateToggle }) {
      const [isMuted, setIsMuted] = useState(false);
      const [bgVolume, setBgVolume] = useState(0.3);
      const [sfxVolume, setSfxVolume] = useState(0.5);
      const [autoNarrate, setAutoNarrate] = useState(true);
      const [showControls, setShowControls] = useState(false);

      const handleMuteToggle = () => {
        const muted = audioManager.toggleMute();
        setIsMuted(muted);
      };

      const handleBgVolumeChange = (e) => {
        const vol = parseFloat(e.target.value);
        setBgVolume(vol);
        audioManager.setBgVolume(vol);
      };

      const handleSfxVolumeChange = (e) => {
        const vol = parseFloat(e.target.value);
        setSfxVolume(vol);
        audioManager.setSfxVolume(vol);
      };

      return (
        <div className="fixed top-4 right-4 z-50">
          <div className="flex items-center gap-2">
            {/* Narrating indicator */}
            {isNarrating && (
              <div className="flex items-center gap-1 bg-purple-600/80 px-3 py-2 rounded-full">
                <div className="flex gap-0.5 items-end h-4">
                  {[...Array(5)].map((_, i) => (
                    <div key={i} className="w-1 bg-white rounded-full sound-wave" style={{height: '4px'}} />
                  ))}
                </div>
                <span className="text-white text-xs ml-1">Speaking...</span>
              </div>
            )}
            
            {/* Quick mute button */}
            <button
              onClick={handleMuteToggle}
              className="bg-slate-800/80 hover:bg-slate-700/80 p-2 rounded-full transition-all"
              title={isMuted ? "Unmute" : "Mute"}
            >
              <span className="text-xl">{isMuted ? 'üîá' : 'üîä'}</span>
            </button>

            {/* Settings button */}
            <button
              onClick={() => setShowControls(!showControls)}
              className="bg-slate-800/80 hover:bg-slate-700/80 p-2 rounded-full transition-all"
            >
              <span className="text-xl">‚öôÔ∏è</span>
            </button>
          </div>

          {/* Expanded controls */}
          {showControls && (
            <div className="absolute top-14 right-0 bg-slate-800/95 backdrop-blur-sm rounded-xl p-4 w-64 border border-purple-500/30 shadow-2xl">
              <h3 className="text-white font-medium mb-4 text-sm">üéµ Audio Settings</h3>
              
              {/* Background Music */}
              <div className="mb-4">
                <label className="text-purple-300 text-xs block mb-1">Background Music</label>
                <input
                  type="range"
                  min="0"
                  max="1"
                  step="0.1"
                  value={bgVolume}
                  onChange={handleBgVolumeChange}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                />
              </div>

              {/* Sound Effects */}
              <div className="mb-4">
                <label className="text-purple-300 text-xs block mb-1">Sound Effects</label>
                <input
                  type="range"
                  min="0"
                  max="1"
                  step="0.1"
                  value={sfxVolume}
                  onChange={handleSfxVolumeChange}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                />
              </div>

              {/* Auto Narration */}
              <div className="flex items-center justify-between">
                <label className="text-purple-300 text-xs">Auto Voice Narration</label>
                <button
                  onClick={() => {
                    setAutoNarrate(!autoNarrate);
                    onNarrateToggle(!autoNarrate);
                    if (autoNarrate) audioManager.stopSpeaking();
                  }}
                  className={`w-12 h-6 rounded-full transition-all ${autoNarrate ? 'bg-purple-600' : 'bg-slate-600'}`}
                >
                  <div className={`w-5 h-5 bg-white rounded-full transition-all transform ${autoNarrate ? 'translate-x-6' : 'translate-x-1'}`} />
                </button>
              </div>

              {/* Stop narration button */}
              {isNarrating && (
                <button
                  onClick={() => audioManager.stopSpeaking()}
                  className="mt-3 w-full bg-red-600/50 hover:bg-red-600/70 text-white py-2 px-3 rounded-lg text-xs transition-all"
                >
                  ‚èπ Stop Narration
                </button>
              )}
            </div>
          )}
        </div>
      );
    }

    // ===== MAIN COMPONENT =====
    function SnowWhiteStory() {
      const [currentNode, setCurrentNode] = useState('prologue');
      const [history, setHistory] = useState([]);
      const [isTransitioning, setIsTransitioning] = useState(false);
      const [showAnalysis, setShowAnalysis] = useState(false);
      const [isNarrating, setIsNarrating] = useState(false);
      const [autoNarrate, setAutoNarrate] = useState(true);
      const [musicStarted, setMusicStarted] = useState(false);

      const node = storyData[currentNode];

      // Start music on first interaction
      const startMusic = useCallback(() => {
        if (!musicStarted) {
          audioManager.playBgMusic();
          setMusicStarted(true);
        }
      }, [musicStarted]);

      // Narrate current node
      useEffect(() => {
        if (!autoNarrate) return;
        
        let textToSpeak = '';
        if (node.type === 'prologue') {
          textToSpeak = node.puzzle;
        } else if (node.type === 'narration') {
          textToSpeak = node.text;
        } else if (node.type === 'inner_thought') {
          textToSpeak = node.text;
        } else if (node.type === 'choice') {
          textToSpeak = node.question;
        } else if (node.type === 'ending') {
          textToSpeak = node.text;
        }

        if (textToSpeak) {
          // Small delay to let transition finish
          const timer = setTimeout(() => {
            setIsNarrating(true);
            audioManager.speak(textToSpeak, () => setIsNarrating(false));
          }, 400);
          return () => clearTimeout(timer);
        }
      }, [currentNode, autoNarrate]);

      // Play sound effects based on node type
      useEffect(() => {
        if (node.type === 'inner_thought') {
          audioManager.playInnerThought();
        } else if (node.type === 'ending') {
          if (node.endingType === 'best') {
            audioManager.playGoodEnding();
          } else if (node.endingType === 'dark') {
            audioManager.playDarkEnding();
          }
        }
      }, [currentNode]);

      const handleNext = (nextId) => {
        startMusic();
        audioManager.playClick();
        audioManager.stopSpeaking();
        setIsTransitioning(true);
        setShowAnalysis(false);
        setTimeout(() => {
          setHistory([...history, currentNode]);
          setCurrentNode(nextId);
          setIsTransitioning(false);
          audioManager.playTransition();
        }, 300);
      };

      const handleChoice = (nextId) => {
        startMusic();
        audioManager.playChoice();
        audioManager.stopSpeaking();
        setIsTransitioning(true);
        setShowAnalysis(false);
        setTimeout(() => {
          setHistory([...history, currentNode]);
          setCurrentNode(nextId);
          setIsTransitioning(false);
        }, 300);
      };

      const handleRetry = (retryPoint) => {
        audioManager.playClick();
        audioManager.stopSpeaking();
        setIsTransitioning(true);
        setShowAnalysis(false);
        setTimeout(() => {
          const retryIndex = history.findIndex(h => h === retryPoint);
          if (retryIndex !== -1) {
            setHistory(history.slice(0, retryIndex));
          } else {
            setHistory([]);
          }
          setCurrentNode(retryPoint);
          setIsTransitioning(false);
        }, 300);
      };

      const handleRestart = () => {
        audioManager.playClick();
        audioManager.stopSpeaking();
        setIsTransitioning(true);
        setShowAnalysis(false);
        setTimeout(() => {
          setHistory([]);
          setCurrentNode('prologue');
          setIsTransitioning(false);
        }, 300);
      };

      const getEndingStyle = (endingType) => {
        const styles = {
          best: 'from-emerald-900 to-emerald-700 border-emerald-400',
          dark: 'from-red-900 to-red-700 border-red-400',
          tragic: 'from-purple-900 to-purple-700 border-purple-400',
          bittersweet: 'from-amber-900 to-amber-700 border-amber-400',
          neutral: 'from-slate-800 to-slate-600 border-slate-400'
        };
        return styles[endingType] || styles.neutral;
      };

      const getEndingLabel = (endingType) => {
        const labels = {
          best: '‚ú® True Ending',
          dark: 'üíÄ Dark Ending',
          tragic: 'üíî Tragic Ending',
          bittersweet: 'üåÖ Bittersweet Ending',
          neutral: '‚öñÔ∏è Neutral Ending'
        };
        return labels[endingType] || 'The End';
      };

      const getFrameworkColor = (framework) => {
        const colors = {
          emerald: 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300',
          violet: 'bg-violet-500/20 border-violet-500/50 text-violet-300',
          red: 'bg-red-500/20 border-red-500/50 text-red-300',
          slate: 'bg-slate-500/20 border-slate-500/50 text-slate-300'
        };
        return colors[frameworkInfo[framework]?.color] || colors.slate;
      };

      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-900 via-purple-900 to-slate-900 flex flex-col items-center justify-center p-4">
          {/* Audio Controls */}
          <AudioControls 
            audioManager={audioManager} 
            isNarrating={isNarrating}
            onNarrateToggle={setAutoNarrate}
          />

          {/* Starfield */}
          <div className="fixed inset-0 overflow-hidden pointer-events-none">
            {[...Array(50)].map((_, i) => (
              <div
                key={i}
                className="absolute w-1 h-1 bg-white rounded-full opacity-40 animate-pulse"
                style={{
                  left: `${Math.random() * 100}%`,
                  top: `${Math.random() * 100}%`,
                  animationDelay: `${Math.random() * 3}s`,
                  animationDuration: `${2 + Math.random() * 2}s`
                }}
              />
            ))}
          </div>

          {/* Header */}
          <div className="text-center mb-6 relative z-10">
            <h1 className="text-4xl md:text-5xl font-serif text-white mb-2 drop-shadow-lg">
              ü™û Snow White
            </h1>
            <p className="text-purple-300 text-sm md:text-base mb-1">
              An Interactive Tale of Power and Forgiveness
            </p>
            <p className="text-purple-400/60 text-xs max-w-md mx-auto italic">
              "What happens to 'goodness' when the power dynamics are reversed?"
            </p>
          </div>

          {/* Main content */}
          <div className={`max-w-2xl w-full transition-all duration-300 relative z-10 ${isTransitioning ? 'opacity-0 translate-y-4' : 'opacity-100 translate-y-0'}`}>
            
            {/* Prologue */}
            {node.type === 'prologue' && (
              <div className="bg-slate-800/90 backdrop-blur-sm rounded-2xl p-6 md:p-8 border border-amber-500/30 shadow-2xl">
                <div className="flex items-center gap-2 mb-4">
                  <span className="text-amber-400 text-2xl">üìú</span>
                  <span className="text-amber-400 font-medium uppercase tracking-wide text-sm">The Puzzle</span>
                </div>
                <p className="text-purple-300 text-base mb-4">{node.text}</p>
                <blockquote className="border-l-4 border-amber-500 pl-4 py-2 mb-6 bg-amber-900/20 rounded-r-lg">
                  <p className="text-white text-lg md:text-xl leading-relaxed font-serif italic">{node.puzzle}</p>
                </blockquote>
                <button onClick={() => handleNext(node.next)} className="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white py-3 px-6 rounded-xl font-medium transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg">
                  üéß Begin the Journey ‚Üí
                </button>
              </div>
            )}

            {/* Inner Thought */}
            {node.type === 'inner_thought' && (
              <div className="bg-purple-900/50 backdrop-blur-sm rounded-2xl p-6 md:p-8 border border-purple-400/30 shadow-2xl">
                <div className="flex items-center gap-2 mb-4">
                  <span className="text-purple-300 text-2xl">üí≠</span>
                  <span className="text-purple-300 font-medium uppercase tracking-wide text-sm">Snow White's Inner Voice</span>
                </div>
                <p className="text-purple-100 text-lg md:text-xl leading-relaxed font-serif italic mb-8">{node.text}</p>
                <button onClick={() => handleNext(node.next)} className="w-full bg-gradient-to-r from-purple-600 to-violet-600 hover:from-purple-500 hover:to-violet-500 text-white py-3 px-6 rounded-xl font-medium transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg">
                  Continue ‚Üí
                </button>
              </div>
            )}

            {/* Narration */}
            {node.type === 'narration' && (
              <div className="bg-slate-800/90 backdrop-blur-sm rounded-2xl p-6 md:p-8 border border-purple-500/30 shadow-2xl">
                <p className="text-white text-lg md:text-xl leading-relaxed font-serif mb-8">{node.text}</p>
                <button onClick={() => handleNext(node.next)} className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white py-3 px-6 rounded-xl font-medium transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg">
                  Continue ‚Üí
                </button>
              </div>
            )}

            {/* Choice */}
            {node.type === 'choice' && (
              <div className="bg-slate-800/90 backdrop-blur-sm rounded-2xl p-6 md:p-8 border border-amber-500/30 shadow-2xl">
                <div className="flex items-center gap-2 mb-4">
                  <span className="text-amber-400 text-2xl">‚öîÔ∏è</span>
                  <span className="text-amber-400 font-medium uppercase tracking-wide text-sm">Decision Point</span>
                </div>
                <p className="text-white text-lg md:text-xl leading-relaxed font-serif mb-3">{node.question}</p>
                {node.context && (
                  <p className="text-purple-300/80 text-sm italic mb-6 border-l-2 border-purple-500/50 pl-3">{node.context}</p>
                )}
                <div className="space-y-3">
                  {node.options.map((option, index) => (
                    <button
                      key={index}
                      onClick={() => handleChoice(option.next)}
                      className="w-full text-left bg-gradient-to-r from-slate-700 to-slate-600 hover:from-amber-700 hover:to-amber-600 text-white py-4 px-5 rounded-xl transition-all duration-200 transform hover:scale-101 active:scale-99 border border-slate-500/50 hover:border-amber-400/50 shadow-md group"
                    >
                      <div className="font-medium">{option.label}</div>
                      {option.subtext && (
                        <div className="text-sm text-slate-400 group-hover:text-amber-200 mt-1 italic">{option.subtext}</div>
                      )}
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Ending */}
            {node.type === 'ending' && (
              <div className={`rounded-2xl border-2 shadow-2xl overflow-hidden bg-gradient-to-br ${getEndingStyle(node.endingType)}`}>
                {node.framework && (
                  <div className={`px-4 py-3 border-b border-white/10 ${getFrameworkColor(node.framework)}`}>
                    <div className="flex items-center gap-2">
                      <span className="text-xl">{frameworkInfo[node.framework].icon}</span>
                      <div>
                        <div className="font-bold text-sm">{frameworkInfo[node.framework].name}</div>
                        <div className="text-xs opacity-80">{frameworkInfo[node.framework].subtitle}</div>
                      </div>
                    </div>
                  </div>
                )}
                
                <div className="p-6 md:p-8">
                  <div className="text-center mb-4">
                    <span className="text-3xl mb-2 block">
                      {node.endingType === 'best' ? 'üëë' : node.endingType === 'dark' ? '‚ö∞Ô∏è' : node.endingType === 'tragic' ? 'üíî' : node.endingType === 'bittersweet' ? 'üåÖ' : '‚è≥'}
                    </span>
                    <span className="text-white font-bold text-xl uppercase tracking-wide">{getEndingLabel(node.endingType)}</span>
                  </div>
                  
                  <p className="text-white text-lg md:text-xl leading-relaxed font-serif mb-6 text-center">{node.text}</p>

                  {node.analysis && (
                    <div className="mb-6">
                      <button
                        onClick={() => { setShowAnalysis(!showAnalysis); audioManager.playClick(); }}
                        className="w-full bg-white/10 hover:bg-white/20 text-white py-2 px-4 rounded-lg text-sm transition-all duration-200 border border-white/20 flex items-center justify-center gap-2"
                      >
                        <span>üîç</span>
                        <span>{showAnalysis ? 'Hide' : 'Show'} Abductive Analysis</span>
                        <span>{showAnalysis ? '‚ñ≤' : '‚ñº'}</span>
                      </button>
                      
                      {showAnalysis && (
                        <div className="mt-4 p-4 bg-black/30 rounded-xl border border-white/10">
                          <h4 className="text-white/80 font-medium mb-2 text-sm uppercase tracking-wide flex items-center gap-2">
                            <span>üìö</span> Theoretical Analysis
                          </h4>
                          <p className="text-white/70 text-sm leading-relaxed">{node.analysis}</p>
                        </div>
                      )}
                    </div>
                  )}
                  
                  <div className="border-t border-white/20 pt-6">
                    <p className="text-white/70 text-center mb-4 text-sm">Explore different paths:</p>
                    <div className="flex flex-wrap gap-2 justify-center mb-4">
                      {node.retryPoints.map((point, index) => (
                        <button
                          key={index}
                          onClick={() => handleRetry(point)}
                          className="bg-white/10 hover:bg-white/20 text-white py-2 px-4 rounded-lg text-sm transition-all duration-200 border border-white/20"
                        >
                          ‚Ü© {choiceLabels[point] || point}
                        </button>
                      ))}
                    </div>
                    <button onClick={handleRestart} className="w-full bg-white/20 hover:bg-white/30 text-white py-3 px-6 rounded-xl font-medium transition-all duration-200 border border-white/30">
                      üîÑ Return to the Beginning
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Journey tracker */}
          {history.length > 0 && (
            <div className="mt-6 flex items-center gap-1 text-purple-400/60 text-xs relative z-10">
              <span>Journey:</span>
              {history.slice(-6).map((h, i) => (
                <span key={i} className="bg-purple-900/50 px-2 py-1 rounded">
                  {storyData[h]?.type === 'choice' ? '‚öîÔ∏è' : storyData[h]?.type === 'inner_thought' ? 'üí≠' : storyData[h]?.type === 'prologue' ? 'üìú' : 'üìñ'}
                </span>
              ))}
            </div>
          )}

          {/* Footer */}
          <footer className="mt-6 text-purple-400/50 text-xs text-center relative z-10">
            üéµ Click anywhere to start background music ‚Ä¢ Based on Brothers Grimm
          </footer>
        </div>
      );
    }

    // Load voices
    window.speechSynthesis.onvoiceschanged = () => {
      window.speechSynthesis.getVoices();
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<SnowWhiteStory />);
  </script>
</body>
</html>
