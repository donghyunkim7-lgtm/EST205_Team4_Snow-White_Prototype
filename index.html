<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snow White - Interactive Tale</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap');
    
    body {
      font-family: 'Crimson Text', Georgia, serif;
      background: linear-gradient(to bottom, #0f172a, #581c87, #0f172a);
      min-height: 100vh;
      color: white;
      padding: 20px;
    }

    .container {
      max-width: 700px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 8px;
      text-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    .header .subtitle {
      color: #c4b5fd;
      font-size: 0.9rem;
    }
    .header .question {
      color: #a78bfa;
      font-size: 0.75rem;
      font-style: italic;
      margin-top: 5px;
    }

    /* Cards */
    .card {
      background: rgba(30, 41, 59, 0.9);
      border-radius: 16px;
      padding: 24px 28px;
      margin-bottom: 20px;
      border: 1px solid rgba(139, 92, 246, 0.3);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card.prologue { border-color: rgba(251, 191, 36, 0.4); }
    .card.inner-thought { 
      background: rgba(88, 28, 135, 0.5); 
      border-color: rgba(192, 132, 252, 0.4);
    }
    .card.choice { border-color: rgba(251, 191, 36, 0.4); }
    .card.ending-best { 
      background: linear-gradient(135deg, #064e3b, #047857);
      border-color: #34d399;
    }
    .card.ending-dark { 
      background: linear-gradient(135deg, #7f1d1d, #991b1b);
      border-color: #f87171;
    }
    .card.ending-bittersweet { 
      background: linear-gradient(135deg, #78350f, #92400e);
      border-color: #fbbf24;
    }
    .card.ending-neutral { 
      background: linear-gradient(135deg, #334155, #475569);
      border-color: #94a3b8;
    }

    /* Labels */
    .label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    .label.puzzle { color: #fbbf24; }
    .label.thought { color: #c4b5fd; }
    .label.decision { color: #fbbf24; }

    /* Text */
    .text {
      font-size: 1.15rem;
      line-height: 1.7;
      margin-bottom: 20px;
    }
    .text.italic { font-style: italic; color: #e9d5ff; }
    
    blockquote {
      border-left: 4px solid #f59e0b;
      padding: 12px 16px;
      margin: 16px 0 24px 0;
      background: rgba(120, 53, 15, 0.3);
      border-radius: 0 8px 8px 0;
      font-style: italic;
    }

    .context {
      font-size: 0.85rem;
      color: #c4b5fd;
      font-style: italic;
      padding-left: 12px;
      border-left: 2px solid rgba(139, 92, 246, 0.5);
      margin-bottom: 20px;
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .btn:hover { transform: scale(1.01); }
    .btn:active { transform: scale(0.99); }

    .btn-primary {
      background: linear-gradient(to right, #9333ea, #db2777);
      color: white;
      text-align: center;
      font-weight: 500;
    }
    .btn-primary:hover { background: linear-gradient(to right, #a855f7, #ec4899); }

    .btn-amber {
      background: linear-gradient(to right, #d97706, #ea580c);
      color: white;
      text-align: center;
      font-weight: 500;
    }
    .btn-amber:hover { background: linear-gradient(to right, #f59e0b, #f97316); }

    .btn-choice {
      background: linear-gradient(to right, #334155, #475569);
      color: white;
      margin-bottom: 10px;
      border: 1px solid rgba(100, 116, 139, 0.5);
    }
    .btn-choice:hover {
      background: linear-gradient(to right, #b45309, #c2410c);
      border-color: rgba(251, 191, 36, 0.5);
    }
    .btn-choice .subtext {
      font-size: 0.8rem;
      color: #94a3b8;
      margin-top: 4px;
      font-style: italic;
    }
    .btn-choice:hover .subtext { color: #fde68a; }

    .btn-ghost {
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      text-align: center;
      margin-top: 10px;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.2); }

    .btn-small {
      display: inline-block;
      width: auto;
      padding: 8px 16px;
      font-size: 0.85rem;
      margin: 4px;
    }

    /* Framework badge */
    .framework-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      border-radius: 8px 8px 0 0;
      margin: -24px -28px 20px -28px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .framework-badge.emotionalism { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
    .framework-badge.karma { background: rgba(139, 92, 246, 0.2); color: #c4b5fd; }
    .framework-badge.dogma { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
    .framework-badge.machiavellian { background: rgba(100, 116, 139, 0.2); color: #cbd5e1; }
    
    .framework-badge .icon { font-size: 1.3rem; }
    .framework-badge .name { font-weight: bold; font-size: 0.85rem; }
    .framework-badge .subtitle { font-size: 0.7rem; opacity: 0.8; }

    /* Ending */
    .ending-header {
      text-align: center;
      margin-bottom: 16px;
    }
    .ending-header .icon { font-size: 2rem; margin-bottom: 8px; }
    .ending-header .title { 
      font-size: 1.2rem; 
      font-weight: bold; 
      text-transform: uppercase; 
      letter-spacing: 2px; 
    }

    .analysis-toggle {
      margin: 20px 0;
    }
    .analysis-content {
      background: rgba(0,0,0,0.3);
      padding: 16px;
      border-radius: 8px;
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .analysis-content p {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
      line-height: 1.6;
    }

    .divider {
      border-top: 1px solid rgba(255,255,255,0.2);
      margin: 24px 0;
      padding-top: 20px;
    }

    .retry-section {
      text-align: center;
    }
    .retry-section p {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 12px;
    }

    /* Journey tracker */
    .journey {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      margin-top: 20px;
      font-size: 0.75rem;
      color: rgba(167, 139, 250, 0.5);
    }
    .journey-item {
      background: rgba(88, 28, 135, 0.5);
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* Audio Controls */
    .audio-controls {
      position: fixed;
      top: 16px;
      right: 16px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }
    .audio-btn {
      background: rgba(30, 41, 59, 0.9);
      border: none;
      padding: 10px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background 0.2s;
    }
    .audio-btn:hover { background: rgba(51, 65, 85, 0.9); }

    .audio-panel {
      position: absolute;
      top: 50px;
      right: 0;
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 12px;
      padding: 16px;
      width: 260px;
      display: none;
    }
    .audio-panel.show { display: block; }
    .audio-panel h4 { margin-bottom: 12px; font-size: 0.9rem; }
    .audio-panel label { 
      display: block; 
      font-size: 0.75rem; 
      color: #c4b5fd; 
      margin-bottom: 4px; 
    }
    .audio-panel input[type="range"] {
      width: 100%;
      margin-bottom: 12px;
    }
    .audio-panel .file-btn {
      width: 100%;
      padding: 10px;
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      margin-bottom: 8px;
    }
    .audio-panel .file-btn:hover { background: #8b5cf6; }
    .audio-panel .status {
      font-size: 0.7rem;
      color: #94a3b8;
      margin-bottom: 8px;
    }
    .audio-panel .status.loaded { color: #4ade80; }

    /* Footer */
    .footer {
      text-align: center;
      margin-top: 30px;
      font-size: 0.75rem;
      color: rgba(167, 139, 250, 0.4);
    }

    /* Stars background */
    .stars {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }
    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      opacity: 0.5;
      animation: twinkle 2s infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.8; }
    }

    /* Hidden file input */
    .hidden-input { display: none; }
  </style>
</head>
<body>
  <!-- Stars Background -->
  <div class="stars" id="stars"></div>

  <!-- Audio Controls -->
  <div class="audio-controls">
    <button class="audio-btn" id="muteBtn" title="ÏùåÏÜåÍ±∞">üîä</button>
    <button class="audio-btn" id="settingsBtn" title="ÏÑ§Ï†ï">‚öôÔ∏è</button>
    <div class="audio-panel" id="audioPanel">
      <h4>üéµ Audio Settings</h4>
      <div class="status" id="musicStatus">üéµ No music loaded</div>
      <button class="file-btn" onclick="document.getElementById('bgmInput').click()">
        üìÅ Select BGM (MP3)
      </button>
      <input type="file" id="bgmInput" class="hidden-input" accept="audio/*">
      <label>Music Volume</label>
      <input type="range" id="bgmVolume" min="0" max="1" step="0.1" value="0.4">
      <label>Effects Volume</label>
      <input type="range" id="sfxVolume" min="0" max="1" step="0.1" value="0.5">
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <div class="header">
      <h1>ü™û Snow White</h1>
      <p class="subtitle">An Interactive Tale of Power and Forgiveness</p>
      <p class="question">"What happens to 'goodness' when power reverses?"</p>
    </div>

    <div id="content"></div>

    <div class="journey" id="journey"></div>

    <p class="footer">üéµ Upload your own BGM via settings ‚Ä¢ Based on Brothers Grimm</p>
  </div>

  <!-- Background Music -->
  <audio id="bgm" loop></audio>

  <script>
    // ===== STORY DATA =====
    const story = {
      prologue: {
        type: 'prologue',
        text: "Before we begin, consider this puzzle:",
        puzzle: "In the original Grimm fairy tale, Snow White‚Äîthe symbol of pure goodness‚Äîwatches silently as the Queen is forced to dance in red-hot iron shoes until she dies. She does not intervene. She does not show mercy. Why?",
        next: 'prologue2'
      },
      prologue2: {
        type: 'narration',
        text: "Perhaps her 'goodness' was never what it seemed. In the fairy tale's absolute monarchy, the Queen stood above all laws. Three times she tried to kill Snow White‚Äîand no court could stop her.",
        next: 'prologue3'
      },
      prologue3: {
        type: 'narration',
        text: "When you have no legal protection, no power, no allies‚Äîwhat choice do you have but to be 'good'? Kindness becomes survival. Gentleness becomes strategy. And perhaps, deep inside, you dream of the day when the positions will be reversed...",
        next: 'start'
      },
      start: {
        type: 'narration',
        text: "Once upon a time... Snow White fled from the kingdom to escape the jealous Queen. She survived three assassination attempts. Now, she is about to marry the prince. And the Queen who tormented her kneels before her, awaiting judgment.",
        next: 'scene1'
      },
      scene1: {
        type: 'narration',
        text: "The Queen enters the grand hall. Hundreds watch in silence. For years, this woman held absolute power. Now she kneels before the girl she tried to destroy.",
        next: 'inner1'
      },
      inner1: {
        type: 'inner_thought',
        text: "Snow White feels something unfamiliar rising in her chest. Is it justice? Satisfaction? Or something she's been suppressing for years?",
        next: 'scene2'
      },
      scene2: {
        type: 'narration',
        text: 'The Prince whispers: "You were her victim. No court could touch her then‚Äîbut now, you ARE the court. The choice is yours."',
        next: 'inner2'
      },
      inner2: {
        type: 'inner_thought',
        text: "For the first time in her life, Snow White holds power over someone who once held power over her. Was her goodness real? Or was it just... waiting?",
        next: 'choice1'
      },
      choice1: {
        type: 'choice',
        question: "The power dynamics have completely reversed. What will Snow White do?",
        context: "This moment will reveal whether her 'goodness' was genuine‚Äîor a survival strategy.",
        options: [
          { label: "A. Give the order to start the punishment", subtext: "Make the Queen pay", next: 'punish1' },
          { label: "B. Interrogate the Queen first", subtext: "Understand before judging", next: 'interrogate1' }
        ]
      },
      punish1: {
        type: 'narration',
        text: 'The crowd erupts: "Burn her!" The Prince nods: "Just give the word."',
        next: 'choice2'
      },
      choice2: {
        type: 'choice',
        question: "The law decrees death by dancing in hot-iron shoes. What should Snow White do?",
        options: [
          { label: "A. Nod coldly‚Äîpolitically necessary", subtext: "Remove the threat", next: 'ending_machiavelli' },
          { label: "B. Demand harder punishment", subtext: "She deserves to suffer", next: 'ending_cynicism' }
        ]
      },
      ending_machiavelli: {
        type: 'ending', framework: 'machiavellian', endingType: 'dark',
        text: "Snow White nods without emotion. The Queen must die‚Äînot from vengeance, but necessity. Her kingdom prospers under firm rule, but she sleeps alone, surrounded by fear rather than love.",
        analysis: "Machiavellian Realism: Her goodness was a rational response to powerlessness. Once she gained power, necessity replaced kindness.",
        retryPoints: ['choice2', 'choice1']
      },
      ending_cynicism: {
        type: 'ending', framework: 'dogma', endingType: 'dark',
        text: "The Queen dies in atrocious agony while Snow White watches. From that day, executions become daily spectacles. She became the hammer. The old stories that called her 'good' now seem like bitter jokes.",
        analysis: "Dogma/Cynicism: Goodness was an illusion‚Äîa tactic of the weak. The victim became the victimizer.",
        retryPoints: ['choice2', 'choice1']
      },
      interrogate1: {
        type: 'narration',
        text: 'Snow White raises her hand, silencing the crowd. "Before judgment‚Äîwhy did you try to kill me? Three times. Why?"',
        next: 'interrogate2'
      },
      interrogate2: {
        type: 'narration',
        text: 'The Queen looks up, surprised. "I was... jealous. I felt alone. I thought everyone would abandon me for you."',
        next: 'choice_interrogate'
      },
      choice_interrogate: {
        type: 'choice',
        question: "Is this the complete truth?",
        options: [
          { label: "A. Accept and show mercy", subtext: "Let cosmic justice decide", next: 'ending_karma' },
          { label: "B. Keep questioning", subtext: "There must be a deeper cause", next: 'emotionalism1' }
        ]
      },
      ending_karma: {
        type: 'ending', framework: 'karma', endingType: 'bittersweet',
        text: "Snow White banishes the Queen to the forest. Years later, the Queen dies alone. Snow White feels sadness and peace‚Äîshe chose not to be the instrument of vengeance.",
        analysis: "Karma: She trusted cosmic justice, maintaining her moral identity by outsourcing punishment to the universe.",
        retryPoints: ['choice_interrogate', 'choice1']
      },
      emotionalism1: {
        type: 'narration',
        text: '"Jealousy doesn\'t appear from nowhere. Who taught you that beauty was everything?"',
        next: 'emotionalism2'
      },
      emotionalism2: {
        type: 'narration',
        text: 'The Queen\'s eyes fill with tears. She points at the mirrors. "It was them... the magic mirror. Every day it told me who was fairest. It made me into this monster."',
        next: 'choice_emotionalism'
      },
      choice_emotionalism: {
        type: 'choice',
        question: "Snow White sees the full picture‚Äîthe Queen, the mirrors, the system.",
        options: [
          { label: "A. Forgive but keep mirrors", subtext: "Personal reconciliation is enough", next: 'ending_incomplete' },
          { label: "B. Destroy mirrors but stay angry", subtext: "Fix the system, not forgive her", next: 'ending_partial' },
          { label: "C. Forgive AND destroy mirrors", subtext: "Address both person and structure", next: 'ending_best' }
        ]
      },
      ending_incomplete: {
        type: 'ending', framework: 'emotionalism', endingType: 'bittersweet',
        text: "Snow White embraces the Queen. But the mirrors remain. Years later, she catches herself asking who is fairest... The cycle was never truly broken.",
        analysis: "Incomplete Moral Idealism: Forgiveness was genuine, but the structural cause remained untreated.",
        retryPoints: ['choice_emotionalism', 'choice1']
      },
      ending_partial: {
        type: 'ending', framework: 'emotionalism', endingType: 'neutral',
        text: "Every mirror is destroyed. No one will ever be told they must be 'the fairest.' But Snow White cannot forgive. Her reign is just‚Äîbut her heart remains scarred.",
        analysis: "Partial victory: She fixed the system but couldn't fully heal herself.",
        retryPoints: ['choice_emotionalism', 'choice1']
      },
      ending_best: {
        type: 'ending', framework: 'emotionalism', endingType: 'best',
        text: "Snow White helps the Queen stand. Together, they shatter the great mirror. Mirrors are replaced with windows‚Äîsymbols of looking outward. The Queen becomes a teacher. Snow White rules not because she must be 'good' to survive, but because she freely chooses to be.",
        analysis: "Full Moral Idealism: Her goodness was not an illusion‚Äîit was a seed that, freed from fear, could finally bloom.",
        retryPoints: ['choice_emotionalism', 'choice1']
      }
    };

    const frameworks = {
      emotionalism: { name: "Moral Idealism", subtitle: "Goodness as Internal Virtue", icon: "üíö" },
      karma: { name: "Karma", subtitle: "Goodness as Cosmic Balance", icon: "‚òØÔ∏è" },
      dogma: { name: "Cynicism", subtitle: "Goodness as Illusion", icon: "üé≠" },
      machiavellian: { name: "Machiavellian", subtitle: "Goodness as Performance", icon: "üëë" }
    };

    const choiceLabels = {
      choice1: "First Choice",
      choice2: "Punishment",
      choice_interrogate: "Understanding",
      choice_emotionalism: "Root Cause"
    };

    // ===== STATE =====
    let currentNode = 'prologue';
    let history = [];
    let isMuted = false;
    let bgmLoaded = false;

    // ===== AUDIO =====
    const bgm = document.getElementById('bgm');
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playTone(freq, dur, type = 'sine', vol = 0.3) {
      if (isMuted) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.frequency.value = freq;
      osc.type = type;
      const sfxVol = parseFloat(document.getElementById('sfxVolume').value);
      gain.gain.setValueAtTime(vol * sfxVol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
      osc.start();
      osc.stop(audioCtx.currentTime + dur);
    }

    function playClick() {
      playTone(800, 0.1, 'sine', 0.2);
      setTimeout(() => playTone(1000, 0.1, 'sine', 0.15), 50);
    }

    function playChoice() {
      playTone(400, 0.15, 'triangle', 0.3);
      setTimeout(() => playTone(500, 0.15, 'triangle', 0.25), 100);
      setTimeout(() => playTone(600, 0.2, 'triangle', 0.2), 200);
    }

    function playGoodEnding() {
      [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => playTone(f, 0.3, 'sine', 0.25), i * 150));
    }

    function playDarkEnding() {
      playTone(200, 0.5, 'sawtooth', 0.2);
      setTimeout(() => playTone(150, 0.5, 'sawtooth', 0.15), 300);
    }

    // ===== RENDER =====
    function render() {
      const node = story[currentNode];
      const content = document.getElementById('content');
      let html = '';

      if (node.type === 'prologue') {
        html = `
          <div class="card prologue">
            <div class="label puzzle">üìú The Puzzle</div>
            <p class="text" style="color: #c4b5fd">${node.text}</p>
            <blockquote>${node.puzzle}</blockquote>
            <button class="btn btn-amber" onclick="goNext('${node.next}')">üéß Begin Journey ‚Üí</button>
          </div>
        `;
      }
      else if (node.type === 'narration') {
        html = `
          <div class="card">
            <p class="text">${node.text}</p>
            <button class="btn btn-primary" onclick="goNext('${node.next}')">Continue ‚Üí</button>
          </div>
        `;
      }
      else if (node.type === 'inner_thought') {
        html = `
          <div class="card inner-thought">
            <div class="label thought">üí≠ Inner Voice</div>
            <p class="text italic">${node.text}</p>
            <button class="btn btn-primary" onclick="goNext('${node.next}')">Continue ‚Üí</button>
          </div>
        `;
      }
      else if (node.type === 'choice') {
        let optionsHtml = node.options.map(opt => `
          <button class="btn btn-choice" onclick="makeChoice('${opt.next}')">
            <div>${opt.label}</div>
            ${opt.subtext ? `<div class="subtext">${opt.subtext}</div>` : ''}
          </button>
        `).join('');

        html = `
          <div class="card choice">
            <div class="label decision">‚öîÔ∏è Decision</div>
            <p class="text">${node.question}</p>
            ${node.context ? `<p class="context">${node.context}</p>` : ''}
            ${optionsHtml}
          </div>
        `;
      }
      else if (node.type === 'ending') {
        const fw = frameworks[node.framework];
        const endingIcons = { best: 'üëë', dark: '‚ö∞Ô∏è', bittersweet: 'üåÖ', neutral: '‚öñÔ∏è' };
        const endingLabels = { best: '‚ú® True Ending', dark: 'üíÄ Dark Ending', bittersweet: 'üåÖ Bittersweet', neutral: '‚öñÔ∏è Neutral' };

        let retryBtns = node.retryPoints.map(p => 
          `<button class="btn btn-ghost btn-small" onclick="retry('${p}')">‚Ü© ${choiceLabels[p] || p}</button>`
        ).join('');

        html = `
          <div class="card ending-${node.endingType}">
            <div class="framework-badge ${node.framework}">
              <span class="icon">${fw.icon}</span>
              <div>
                <div class="name">${fw.name}</div>
                <div class="subtitle">${fw.subtitle}</div>
              </div>
            </div>
            <div class="ending-header">
              <div class="icon">${endingIcons[node.endingType]}</div>
              <div class="title">${endingLabels[node.endingType]}</div>
            </div>
            <p class="text" style="text-align: center">${node.text}</p>
            <div class="analysis-toggle">
              <button class="btn btn-ghost" onclick="toggleAnalysis()">üîç Show Analysis</button>
              <div class="analysis-content" id="analysisContent" style="display: none">
                <p>${node.analysis}</p>
              </div>
            </div>
            <div class="divider"></div>
            <div class="retry-section">
              <p>Try different paths:</p>
              ${retryBtns}
              <button class="btn btn-ghost" onclick="restart()">üîÑ Start Over</button>
            </div>
          </div>
        `;

        // Play ending sound
        if (node.endingType === 'best') playGoodEnding();
        else if (node.endingType === 'dark') playDarkEnding();
      }

      content.innerHTML = html;
      updateJourney();
    }

    function goNext(nextId) {
      playClick();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      if (bgmLoaded && bgm.paused && !isMuted) bgm.play();
      
      history.push(currentNode);
      currentNode = nextId;
      render();
    }

    function makeChoice(nextId) {
      playChoice();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      if (bgmLoaded && bgm.paused && !isMuted) bgm.play();
      
      history.push(currentNode);
      currentNode = nextId;
      render();
    }

    function retry(point) {
      playClick();
      const idx = history.indexOf(point);
      history = idx !== -1 ? history.slice(0, idx) : [];
      currentNode = point;
      render();
    }

    function restart() {
      playClick();
      history = [];
      currentNode = 'prologue';
      render();
    }

    function toggleAnalysis() {
      const el = document.getElementById('analysisContent');
      el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function updateJourney() {
      const journey = document.getElementById('journey');
      if (history.length === 0) {
        journey.innerHTML = '';
        return;
      }
      const icons = history.slice(-6).map(h => {
        const t = story[h]?.type;
        const icon = t === 'choice' ? '‚öîÔ∏è' : t === 'inner_thought' ? 'üí≠' : 'üìñ';
        return `<span class="journey-item">${icon}</span>`;
      }).join('');
      journey.innerHTML = `<span>Journey:</span> ${icons}`;
    }

    // ===== AUDIO CONTROLS =====
    document.getElementById('muteBtn').onclick = () => {
      isMuted = !isMuted;
      document.getElementById('muteBtn').textContent = isMuted ? 'üîá' : 'üîä';
      if (isMuted) bgm.pause();
      else if (bgmLoaded) bgm.play();
    };

    document.getElementById('settingsBtn').onclick = () => {
      document.getElementById('audioPanel').classList.toggle('show');
    };

    document.getElementById('bgmInput').onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        bgm.src = URL.createObjectURL(file);
        bgm.load();
        bgmLoaded = true;
        document.getElementById('musicStatus').textContent = 'üéµ ' + file.name;
        document.getElementById('musicStatus').classList.add('loaded');
        if (!isMuted) bgm.play();
      }
    };

    document.getElementById('bgmVolume').oninput = (e) => {
      bgm.volume = e.target.value;
    };

    // ===== STARS =====
    function createStars() {
      const container = document.getElementById('stars');
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        container.appendChild(star);
      }
    }

    // ===== INIT =====
    createStars();
    render();

    // Try loading local bgm.mp3
    bgm.src = 'bgm.mp3';
    bgm.oncanplaythrough = () => {
      bgmLoaded = true;
      document.getElementById('musicStatus').textContent = 'üéµ bgm.mp3 loaded';
      document.getElementById('musicStatus').classList.add('loaded');
    };
    bgm.onerror = () => {
      console.log('üí° Tip: Add bgm.mp3 to the same folder for background music');
    };
  </script>
</body>
</html>
